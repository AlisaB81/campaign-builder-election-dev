<%- include('../partials/nav') %>
<script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" id="app">
    <div class="py-6 space-y-6">
        <div class="bg-white shadow rounded-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900">Phone Numbers</h1>
            <p class="text-gray-600 mt-1">Search for phone numbers and accounts, then purchase from Twilio and add numbers directly to an account on this screen.</p>
        </div>

        <!-- Search accounts + Search numbers + Purchase & assign (admin) -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Purchase from Twilio & assign to account</h2>

            <!-- Account search and select -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                <input v-model="accountSearchQuery" type="text" placeholder="Search by email or name…" class="border rounded-md px-3 py-2 w-full max-w-md text-sm mb-2">
                <select v-model="assignAccountId" class="w-full max-w-md border rounded-md px-3 py-2 text-sm">
                    <option value="">Select account holder</option>
                    <option v-for="u in filteredAccountHolders" :key="u.id" :value="u.id">{{ accountLabel(u) }}</option>
                </select>
            </div>

            <!-- Number search -->
            <div class="flex flex-wrap items-end gap-3 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Area code</label>
                    <input v-model="areaCode" type="text" placeholder="e.g. 250" maxlength="3" class="border rounded-md px-3 py-2 w-24"
                        @keypress="onlyNumbers">
                </div>
                <button @click="searchNumbers" :disabled="!areaCode || searching" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50 text-sm font-medium">
                    {{ searching ? 'Searching…' : 'Search numbers' }}
                </button>
            </div>

            <!-- Available numbers: Purchase & assign -->
            <div v-if="availableNumbers.length" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="n in availableNumbers" :key="n.phoneNumber" class="border rounded-lg p-4 bg-gray-50">
                    <div class="font-medium">{{ n.phoneNumber }}</div>
                    <div class="text-sm text-gray-600">{{ n.locality }}, {{ n.region }}</div>
                    <div class="text-sm text-gray-600 mb-3">${{ n.monthlyPrice }}/month</div>
                    <button type="button"
                            :disabled="!assignAccountId || paddleOpening"
                            @click="openPaddlePayment(n)"
                            class="w-full px-3 py-1.5 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        {{ paddleOpening ? 'Opening payment…' : 'Purchase & assign to account' }}
                    </button>
                </div>
            </div>
            <p v-if="availableNumbers.length && !assignAccountId" class="text-sm text-amber-600 mt-2">Select an account above to enable Purchase & assign.</p>
            <p v-if="purchaseError" class="text-sm text-red-600 mt-2">{{ purchaseError }}</p>
            <p v-if="purchaseSuccess" class="text-sm text-green-600 mt-2">{{ purchaseSuccess }}</p>
            <p class="text-sm text-gray-500 mt-3">Enter an area code (e.g. 250), click Search numbers, select an account above, then click &quot;Purchase &amp; assign to account&quot; on a number to buy it from Twilio and add it to that account.</p>
        </div>

        <!-- Paddle payment modal -->
        <div v-if="showPaddleModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Purchase phone number</h3>
                <p class="text-sm text-gray-600 mb-4">
                    You are purchasing <span class="font-medium text-gray-900">{{ selectedNumberForPayment }}</span>
                    for account <span class="font-medium text-gray-900">{{ selectedAccountLabel }}</span>.
                </p>
                <p class="text-sm text-gray-600 mb-4">Click Continue to open Paddle checkout.</p>
                <p v-if="purchaseError" class="text-sm text-red-600 mb-3">{{ purchaseError }}</p>
                <div class="flex justify-end gap-2">
                    <button type="button"
                            class="px-4 py-2 border rounded-md text-sm text-gray-700 hover:bg-gray-50"
                            :disabled="paddleOpening"
                            @click="closePaddleModal">
                        Cancel
                    </button>
                    <button type="button"
                            class="px-4 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 disabled:opacity-50"
                            :disabled="paddleOpening"
                            @click="startPaddleCheckout">
                        {{ paddleOpening ? 'Opening…' : 'Continue to payment' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Assign existing phone number to account (admin) -->
        <div v-if="isAdmin" class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Assign existing number to account</h2>
            <p class="text-sm text-gray-600 mb-4">Assign a number from your admin pool to an account.</p>
            <div class="flex flex-wrap items-end gap-4">
                <div class="min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Account</label>
                    <select v-model="assignAccountId" class="w-full border rounded-md px-3 py-2 text-sm">
                        <option value="">Select account holder</option>
                        <option v-for="u in accountHolders" :key="u.id" :value="u.id">{{ accountLabel(u) }}</option>
                    </select>
                </div>
                <div class="min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone number</label>
                    <select v-model="assignPhoneNumber" class="w-full border rounded-md px-3 py-2 text-sm">
                        <option value="">Select number</option>
                        <option v-for="n in assignablePhoneNumbers" :key="n.id" :value="n.number">{{ n.number }}</option>
                    </select>
                </div>
                <button type="button"
                        :disabled="assignSubmitting || !assignAccountId || !assignPhoneNumber"
                        @click="assignPhoneNumberToAccount"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50 text-sm font-medium">
                    {{ assignSubmitting ? 'Assigning…' : 'Assign' }}
                </button>
            </div>
            <p v-if="assignError" class="mt-2 text-sm text-red-600">{{ assignError }}</p>
            <p v-if="assignSuccess" class="mt-2 text-sm text-green-600">{{ assignSuccess }}</p>
        </div>

        <!-- All phone numbers -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">All phone numbers</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monthly Cost</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Purchased</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-if="phoneNumbers.length === 0">
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">No phone numbers found.</td>
                        </tr>
                        <tr v-for="n in phoneNumbers" :key="n.id">
                            <td class="px-6 py-4 whitespace-nowrap font-medium">{{ n.number }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">{{ n.userEmail || '—' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ n.accountId || '—' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${{ n.monthlyPrice || '4.00' }} CAD</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ n.purchasedAt ? new Date(n.purchasedAt).toLocaleDateString() : '—' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="n.isDefault ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" class="px-2 py-1 text-xs rounded-full">{{ n.isDefault ? 'Default' : 'Active' }}</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            isAdmin: <%= typeof user !== 'undefined' && user && (user.userType === 'app_owner' || user.isAdmin === true) ? 'true' : 'false' %>,
            accountHolders: [],
            accountSearchQuery: '',
            assignablePhoneNumbers: [],
            phoneNumbers: [],
            assignAccountId: '',
            assignPhoneNumber: '',
            assignSubmitting: false,
            assignError: '',
            assignSuccess: '',
            areaCode: '',
            searching: false,
            availableNumbers: [],
            purchasingFor: '',
            purchaseError: '',
            purchaseSuccess: '',
            showPaddleModal: false,
            selectedNumberForPayment: '',
            selectedAccountForPayment: '',
            paddleOpening: false
        };
    },
    computed: {
        filteredAccountHolders() {
            const q = (this.accountSearchQuery || '').toLowerCase().trim();
            if (!q) return this.accountHolders;
            return this.accountHolders.filter(u => {
                const email = (u.email || '').toLowerCase();
                const name = (u.personalInfo && (u.personalInfo.firstName + ' ' + (u.personalInfo.lastName || '')).trim() || '').toLowerCase();
                const id = String(u.id || '');
                return email.includes(q) || name.includes(q) || id.includes(q);
            });
        },
        selectedAccountLabel() {
            const accountId = String(this.selectedAccountForPayment || this.assignAccountId || '');
            const user = this.accountHolders.find(u => String(u.id) === accountId);
            return user ? this.accountLabel(user) : accountId;
        }
    },
    methods: {
        getAuthHeaders() {
            const token = typeof localStorage !== 'undefined' && localStorage.getItem('token');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        },
        accountLabel(u) {
            const name = u.personalInfo && [u.personalInfo.firstName, u.personalInfo.lastName].filter(Boolean).join(' ');
            return (u.email || name || 'User') + ' (ID: ' + u.id + ')';
        },
        onlyNumbers(e) {
            if (e.key && /[^0-9]/.test(e.key)) e.preventDefault();
        },
        async searchNumbers() {
            if (!this.areaCode) return;
            this.searching = true;
            try {
                const r = await fetch('/api/numbers/search?areaCode=' + encodeURIComponent(this.areaCode), { credentials: 'include', headers: this.getAuthHeaders() });
                if (r.ok) {
                    const data = await r.json();
                    this.availableNumbers = data.numbers || [];
                } else {
                    const err = await r.json().catch(() => ({}));
                    alert(err.error || 'Search failed');
                }
            } catch (e) {
                alert(e.message || 'Search failed');
            } finally {
                this.searching = false;
            }
        },
        openPaddlePayment(n) {
            if (!this.assignAccountId || !n || !n.phoneNumber) return;
            this.purchaseError = '';
            this.purchaseSuccess = '';
            this.selectedNumberForPayment = n.phoneNumber;
            this.selectedAccountForPayment = String(this.assignAccountId);
            this.showPaddleModal = true;
        },
        closePaddleModal() {
            if (this.paddleOpening) return;
            this.showPaddleModal = false;
            this.selectedNumberForPayment = '';
            this.selectedAccountForPayment = '';
        },
        async startPaddleCheckout() {
            if (!this.selectedNumberForPayment || !this.selectedAccountForPayment) return;
            this.purchaseError = '';
            this.purchaseSuccess = '';
            this.paddleOpening = true;
            try {
                const r = await fetch('/api/admin/numbers/paddle-checkout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, this.getAuthHeaders()),
                    body: JSON.stringify({
                        phoneNumber: this.selectedNumberForPayment,
                        userId: this.selectedAccountForPayment
                    })
                });
                if (!r.ok) {
                    const err = await r.json().catch(() => ({}));
                    throw new Error(err.error || 'Failed to prepare checkout');
                }

                const { clientToken, priceId, customData, paddleEnv } = await r.json();
                if (!window.Paddle) throw new Error('Paddle did not load');

                const self = this;
                const eventCallback = (e) => {
                    if (e && e.name === 'checkout.completed') {
                        const purchasedNumber = self.selectedNumberForPayment;
                        self.showPaddleModal = false;
                        self.purchaseSuccess = `Payment completed for ${purchasedNumber}. Number will be assigned shortly.`;
                        self.availableNumbers = self.availableNumbers.filter(x => x.phoneNumber !== purchasedNumber);
                        setTimeout(() => { self.loadPhoneNumbers(); }, 2500);
                        setTimeout(() => { self.purchaseSuccess = ''; }, 6000);
                        self.selectedNumberForPayment = '';
                        self.selectedAccountForPayment = '';
                    }
                };

                if (window.Paddle.Environment && (paddleEnv === 'sandbox' || paddleEnv === 'production')) {
                    window.Paddle.Environment.set(paddleEnv);
                }
                if (!window.Paddle.Initialized) {
                    window.Paddle.Initialize({ token: clientToken, eventCallback });
                }
                window.Paddle.Checkout.open({
                    items: [{ priceId, quantity: 1 }],
                    customData
                });
            } catch (e) {
                this.purchaseError = e.message || 'Request failed';
            } finally {
                this.paddleOpening = false;
            }
        },
        async loadAccountHolders() {
            try {
                const r = await fetch('/api/admin/users', { credentials: 'include', headers: this.getAuthHeaders() });
                if (r.ok) {
                    const data = await r.json();
                    const users = data.users || data || [];
                    this.accountHolders = users.filter(u => u.userType === 'account_holder');
                }
            } catch (e) { console.error(e); }
        },
        async loadAssignablePhoneNumbers() {
            if (!this.isAppOwner) return;
            try {
                const r = await fetch('/api/admin/assignable-phone-numbers', { credentials: 'include', headers: this.getAuthHeaders() });
                if (r.ok) this.assignablePhoneNumbers = await r.json();
            } catch (e) { console.error(e); }
        },
        async loadPhoneNumbers() {
            try {
                const r = await fetch('/api/admin/numbers', { credentials: 'include', headers: this.getAuthHeaders() });
                if (r.ok) this.phoneNumbers = await r.json();
            } catch (e) {
                console.error(e);
            }
        },
        async assignPhoneNumberToAccount() {
            if (!this.assignAccountId || !this.assignPhoneNumber) return;
            this.assignError = '';
            this.assignSuccess = '';
            this.assignSubmitting = true;
            try {
                const r = await fetch('/api/admin/numbers', {
                    method: 'POST',
                    credentials: 'include',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, this.getAuthHeaders()),
                    body: JSON.stringify({ userId: this.assignAccountId, number: this.assignPhoneNumber })
                });
                const data = await r.json().catch(() => ({}));
                if (r.ok) {
                    this.assignSuccess = 'Number assigned successfully.';
                    this.assignPhoneNumber = '';
                    await this.loadAssignablePhoneNumbers();
                    await this.loadPhoneNumbers();
                } else {
                    this.assignError = data.error || 'Assign failed';
                }
            } catch (e) {
                this.assignError = e.message || 'Request failed';
            } finally {
                this.assignSubmitting = false;
            }
        }
    },
    async created() {
        await this.loadAccountHolders();
        await this.loadAssignablePhoneNumbers();
        await this.loadPhoneNumbers();
    }
}).mount('#app');
</script>
