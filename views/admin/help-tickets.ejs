<%- include('../partials/nav') %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" id="app">
    <div class="py-6 space-y-6">
        <!-- Header -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Help Tickets</h1>
                    <p class="text-gray-600 mt-1">Manage and respond to user support requests (support, bugs, general questions).</p>
                    <p class="text-sm text-amber-700 mt-2 bg-amber-50 px-3 py-2 rounded-md">For campaigns, tokens, or billing requests, users should use the <a href="/requests" class="font-medium text-indigo-600 hover:text-indigo-800">Requests</a> page.</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <button @click="refreshTickets" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 rounded-lg p-4">
                    <div class="text-red-600 text-sm font-medium">Open</div>
                    <div class="text-2xl font-bold text-red-900">{{ getStatusCount('Open') }}</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4">
                    <div class="text-yellow-600 text-sm font-medium">In Progress</div>
                    <div class="text-2xl font-bold text-yellow-900">{{ getStatusCount('In Progress') }}</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-green-600 text-sm font-medium">Closed</div>
                    <div class="text-2xl font-bold text-green-900">{{ getStatusCount('Closed') }}</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-blue-600 text-sm font-medium">Total</div>
                    <div class="text-2xl font-bold text-blue-900">{{ tickets.length }}</div>
                </div>
            </div>
        </div>

        <!-- Tickets Table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">All Help Tickets</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ticket #
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                User
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Page
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="ticket in tickets" :key="ticket.ticketNumber" 
                            class="hover:bg-gray-50 cursor-pointer"
                            @click="selectTicket(ticket)">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ ticket.ticketNumber }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ ticket.userFullName }}</div>
                                <div class="text-sm text-gray-500">{{ ticket.userEmail }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ ticket.page }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="getStatusClasses(ticket.status)" 
                                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                    {{ ticket.status }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ formatDate(ticket.createdAt) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button @click.stop="selectTicket(ticket)"
                                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                                    View
                                </button>
                                <button @click.stop="updateStatus(ticket)"
                                        class="text-green-600 hover:text-green-900">
                                    Update Status
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div v-if="selectedTicket" 
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        Ticket {{ selectedTicket.ticketNumber }}
                    </h3>
                    <button @click="selectedTicket = null" 
                            class="text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="space-y-4">
                    <!-- Ticket Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">User</label>
                            <p class="mt-1 text-sm text-gray-900">{{ selectedTicket.userFullName }}</p>
                            <p class="text-sm text-gray-500">{{ selectedTicket.userEmail }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <span :class="getStatusClasses(selectedTicket.status)" 
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                {{ selectedTicket.status }}
                            </span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Page</label>
                            <p class="mt-1 text-sm text-gray-900">{{ selectedTicket.page }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Created</label>
                            <p class="mt-1 text-sm text-gray-900">{{ formatDate(selectedTicket.createdAt) }}</p>
                        </div>
                    </div>

                    <!-- User Message -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">User Message</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ selectedTicket.message }}</p>
                        </div>
                    </div>

                    <!-- Admin Reply Section -->
                    <div v-if="!selectedTicket.adminReply">
                        <label class="block text-sm font-medium text-gray-700">Admin Reply</label>
                        <textarea v-model="adminReplyText" 
                                  rows="4"
                                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Enter your reply to the user..."></textarea>
                        <div class="mt-2 flex justify-end">
                            <button @click="submitReply" 
                                    :disabled="!adminReplyText.trim()"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                Submit Reply
                            </button>
                        </div>
                    </div>

                    <!-- Existing Admin Reply -->
                    <div v-else>
                        <label class="block text-sm font-medium text-gray-700">Admin Reply</label>
                        <div class="mt-1 p-3 bg-green-50 rounded-md">
                            <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ selectedTicket.adminReply }}</p>
                            <p class="text-xs text-gray-500 mt-2">Replied on {{ formatDate(selectedTicket.repliedAt) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div v-if="statusUpdateTicket" 
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Update Status</h3>
                    <button @click="statusUpdateTicket = null" 
                            class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ticket</label>
                        <p class="mt-1 text-sm text-gray-900">{{ statusUpdateTicket.ticketNumber }}</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Current Status</label>
                        <span :class="getStatusClasses(statusUpdateTicket.status)" 
                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                            {{ statusUpdateTicket.status }}
                        </span>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">New Status</label>
                        <select v-model="newStatus" 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button @click="statusUpdateTicket = null" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Cancel
                        </button>
                        <button @click="submitStatusUpdate" 
                                class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700">
                            Update Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            tickets: [],
            selectedTicket: null,
            statusUpdateTicket: null,
            adminReplyText: '',
            newStatus: 'Open',
            loading: false
        }
    },
    async mounted() {
        await this.loadTickets();
    },
    methods: {
        async loadTickets() {
            try {
                this.loading = true;
                const response = await fetch('/api/admin/help-tickets');
                const data = await response.json();
                
                if (response.ok) {
                    this.tickets = data.tickets;
                } else {
                    console.error('Error loading tickets:', data.error);
                    this.showToast('Error loading tickets: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                this.showToast('Error loading tickets', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async refreshTickets() {
            await this.loadTickets();
            this.showToast('Tickets refreshed', 'success');
        },
        
        selectTicket(ticket) {
            this.selectedTicket = ticket;
            this.adminReplyText = '';
        },
        
        updateStatus(ticket) {
            this.statusUpdateTicket = ticket;
            this.newStatus = ticket.status;
        },
        
        async submitReply() {
            if (!this.adminReplyText.trim()) return;
            
            try {
                const response = await fetch(`/api/admin/help-tickets/${this.selectedTicket.ticketNumber}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        adminReply: this.adminReplyText
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.showToast('Reply submitted successfully', 'success');
                    this.selectedTicket = null;
                    await this.loadTickets();
                } else {
                    this.showToast('Error submitting reply: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error submitting reply:', error);
                this.showToast('Error submitting reply', 'error');
            }
        },
        
        async submitStatusUpdate() {
            try {
                const response = await fetch(`/api/admin/help-tickets/${this.statusUpdateTicket.ticketNumber}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: this.newStatus
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.showToast('Status updated successfully', 'success');
                    this.statusUpdateTicket = null;
                    await this.loadTickets();
                } else {
                    this.showToast('Error updating status: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                this.showToast('Error updating status', 'error');
            }
        },
        
        getStatusCount(status) {
            return this.tickets.filter(ticket => ticket.status === status).length;
        },
        
        getStatusClasses(status) {
            const baseClasses = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium';
            
            switch (status) {
                case 'Open':
                    return `${baseClasses} bg-red-100 text-red-800`;
                case 'In Progress':
                    return `${baseClasses} bg-yellow-100 text-yellow-800`;
                case 'Closed':
                    return `${baseClasses} bg-green-100 text-green-800`;
                default:
                    return `${baseClasses} bg-gray-100 text-gray-800`;
            }
        },
        
        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        },
        
        showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    }
}).mount('#app');
</script>
