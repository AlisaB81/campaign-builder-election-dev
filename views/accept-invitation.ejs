<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accept Invitation - Campaign Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .invitation-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .invitation-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 500px;
            width: 100%;
        }
        .invitation-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .invitation-body {
            padding: 30px;
        }
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        .btn-accept {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            color: white;
            font-weight: 500;
            width: 100%;
        }
        .btn-accept:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            color: white;
        }
        .error-alert {
            background: #fee;
            border: 1px solid #fcc;
            color: #c44;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .success-alert {
            background: #efe;
            border: 1px solid #cfc;
            color: #484;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .input-group .btn-outline-secondary {
            border-color: #ced4da;
            color: #6c757d;
        }
        .input-group .btn-outline-secondary:hover {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }
        .form-text {
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <div id="app" class="invitation-container">
        <div class="invitation-card">
            <div class="invitation-header">
                <h2>üë• Join the Team</h2>
                <p class="mb-0">You've been invited to Campaign Builder</p>
            </div>
            <div class="invitation-body">
                <!-- Loading State -->
                <div v-if="loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Validating invitation...</p>
                </div>

                <!-- Error State -->
                <div v-else-if="error" class="text-center">
                    <div class="error-alert">
                        <h5>Invitation Error</h5>
                        <p>{{ error }}</p>
                    </div>
                    <a href="/login" class="btn btn-secondary">Back to Login</a>
                </div>

                <!-- Success State -->
                <div v-else-if="success" class="text-center">
                    <div class="success-alert">
                        <h5>Welcome to the team!</h5>
                        <p>Your account has been created successfully.</p>
                    </div>
                    <a href="/login" class="btn btn-accept">Go to Login</a>
                </div>

                <!-- Form State -->
                <div v-else>
                    <div v-if="invitation">
                        <div class="mb-3 text-center">
                            <p><strong>{{ inviterEmail }}</strong> has invited you to join their team.</p>
                            <p class="text-muted">Create your account to get started.</p>
                        </div>
                    </div>

                    <form @submit.prevent="acceptInvitation">
                        <div v-if="formError" class="error-alert">
                            {{ formError }}
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" 
                                   class="form-control" 
                                   id="email" 
                                   v-model="formData.email" 
                                   :readonly="true"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="firstName" 
                                   v-model="formData.firstName" 
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="lastName" 
                                   v-model="formData.lastName" 
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" 
                                   class="form-control" 
                                   id="phone" 
                                   v-model="formData.phone"
                                   placeholder="(123) 456-7890"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <small class="form-text text-muted">
                                Create a secure password
                            </small>
                            <div class="input-group">
                                <input :type="showPassword ? 'text' : 'password'" 
                                       class="form-control" 
                                       id="password" 
                                       v-model="formData.password" 
                                       @input="validatePassword"
                                       minlength="8"
                                       placeholder="Enter your password"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        @click="showPassword = !showPassword"
                                        :title="showPassword ? 'Hide password' : 'Show password'">
                                    {{ showPassword ? 'üôà' : 'üëÅÔ∏è' }}
                                </button>
                            </div>
                            
                            <!-- Password Requirements -->
                            <div v-if="formData.password" class="mt-2 p-3 bg-gray-50 rounded-md border border-gray-200">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Password Requirements:</h4>
                                <ul class="text-xs space-y-1">
                                    <li :class="passwordRequirements.length ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.length" class="inline-block w-4">‚úì</span>
                                        <span v-else class="inline-block w-4">‚óã</span>
                                        At least 8 characters
                                    </li>
                                    <li :class="passwordRequirements.uppercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.uppercase" class="inline-block w-4">‚úì</span>
                                        <span v-else class="inline-block w-4">‚óã</span>
                                        At least 1 uppercase letter
                                    </li>
                                    <li :class="passwordRequirements.lowercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.lowercase" class="inline-block w-4">‚úì</span>
                                        <span v-else class="inline-block w-4">‚óã</span>
                                        At least 1 lowercase letter
                                    </li>
                                    <li :class="passwordRequirements.number ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.number" class="inline-block w-4">‚úì</span>
                                        <span v-else class="inline-block w-4">‚óã</span>
                                        At least 1 number
                                    </li>
                                    <li :class="passwordRequirements.special ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.special" class="inline-block w-4">‚úì</span>
                                        <span v-else class="inline-block w-4">‚óã</span>
                                        At least 1 special character (!@#$%^&*)
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <small class="form-text text-muted">
                                Re-enter your password to confirm
                            </small>
                            <div class="input-group">
                                <input :type="showConfirmPassword ? 'text' : 'password'" 
                                       class="form-control" 
                                       id="confirmPassword" 
                                       v-model="formData.confirmPassword" 
                                       @input="validatePassword"
                                       placeholder="Confirm your password"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        @click="showConfirmPassword = !showConfirmPassword"
                                        :title="showConfirmPassword ? 'Hide password' : 'Show password'">
                                    {{ showConfirmPassword ? 'üôà' : 'üëÅÔ∏è' }}
                                </button>
                            </div>
                            <p v-if="passwordMismatch" class="mt-1 text-sm text-red-600">
                                Passwords do not match
                            </p>
                        </div>

                        <button type="submit" 
                                class="btn btn-accept" 
                                :disabled="submitting">
                            <span v-if="submitting">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Creating Account...
                            </span>
                            <span v-else>
                                Accept Invitation & Create Account
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    success: false,
                    formError: null,
                    submitting: false,
                    invitation: null,
                    inviterEmail: '',
                    token: '',
                    formData: {
                        email: '',
                        firstName: '',
                        lastName: '',
                        phone: '',
                        password: '',
                        confirmPassword: ''
                    },
                    showPassword: false,
                    showConfirmPassword: false,
                    passwordRequirements: {
                        length: false,
                        uppercase: false,
                        lowercase: false,
                        number: false,
                        special: false
                    },
                    passwordMismatch: false
                };
            },
            async mounted() {
                // Get token from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.token = urlParams.get('token');

                if (!this.token) {
                    this.error = 'No invitation token provided';
                    this.loading = false;
                    return;
                }

                await this.validateInvitation();
            },
            methods: {
                validatePassword() {
                    if (!this.formData.password) {
                        this.passwordRequirements = {
                            length: false,
                            uppercase: false,
                            lowercase: false,
                            number: false,
                            special: false
                        };
                        return;
                    }

                    // Check password requirements
                    this.passwordRequirements = {
                        length: this.formData.password.length >= 8,
                        uppercase: /[A-Z]/.test(this.formData.password),
                        lowercase: /[a-z]/.test(this.formData.password),
                        number: /[0-9]/.test(this.formData.password),
                        special: /[!@#$%^&*]/.test(this.formData.password)
                    };

                    // Check if passwords match
                    if (this.formData.confirmPassword) {
                        this.passwordMismatch = this.formData.password !== this.formData.confirmPassword;
                    } else {
                        this.passwordMismatch = false;
                    }
                },
                async validateInvitation() {
                    try {
                        const response = await fetch(`/api/invitations/validate?token=${this.token}`);
                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Invalid invitation');
                        }

                        this.invitation = data.invitation;
                        this.formData.email = data.invitation.email;
                        this.inviterEmail = data.inviterEmail || 'A team member';
                        this.loading = false;

                    } catch (error) {
                        this.error = error.message;
                        this.loading = false;
                    }
                },
                async acceptInvitation() {
                    if (this.formData.password !== this.formData.confirmPassword) {
                        this.formError = 'Passwords do not match';
                        return;
                    }

                    if (this.formData.password.length < 8) {
                        this.formError = 'Password must be at least 8 characters';
                        return;
                    }
                    
                    // Check if all password requirements are met
                    if (!this.passwordRequirements.length || 
                        !this.passwordRequirements.uppercase || 
                        !this.passwordRequirements.lowercase || 
                        !this.passwordRequirements.number || 
                        !this.passwordRequirements.special) {
                        this.formError = 'Password does not meet all requirements';
                        return;
                    }

                    this.submitting = true;
                    this.formError = null;

                    try {
                        const response = await fetch('/api/users/accept-invitation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                token: this.token,
                                userData: {
                                    email: this.formData.email,
                                    password: this.formData.password,
                                    firstName: this.formData.firstName,
                                    lastName: this.formData.lastName,
                                    phone: this.formData.phone
                                }
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Failed to accept invitation');
                        }

                        this.success = true;

                    } catch (error) {
                        this.formError = error.message;
                    } finally {
                        this.submitting = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
