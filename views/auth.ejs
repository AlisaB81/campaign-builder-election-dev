<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Campaign Builder</title>
    <% 
    // Skip base tag for localhost so redirects stay on same origin and cookies are sent
    const baseUrlVal = typeof baseUrl !== 'undefined' ? baseUrl : (typeof locals !== 'undefined' && locals.baseUrl ? locals.baseUrl : '');
    const isLocalhost = !baseUrlVal || baseUrlVal.includes('localhost') || baseUrlVal.includes('127.0.0.1') ||
                        (typeof locals !== 'undefined' && locals.IS_STAGING);
    if (!isLocalhost && baseUrlVal) {
    %>
    <base href="<%= baseUrlVal %>">
    <% } %>
    <link rel="stylesheet" href="/css/tailwind.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- iPad/iOS specific optimizations -->
    <style>
        /* Prevent zoom on input focus for iOS */
        input[type="text"], input[type="email"], input[type="password"], input[type="tel"] {
            font-size: 16px !important;
        }
        
        /* Improve touch targets for mobile */
        button, input, select, textarea {
            min-height: 44px;
        }
        
        /* Prevent iOS Safari from adding rounded corners */
        input, button {
            -webkit-appearance: none;
            appearance: none;
            border-radius: 0;
        }
        
        /* Fix iOS Safari input styling */
        input:focus {
            -webkit-appearance: none;
            appearance: none;
            outline: none;
        }
        
        /* Ensure proper touch handling */
        .touch-manipulation {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gray-100">
<noscript>
    <div style="max-width:400px;margin:80px auto 0;padding:24px;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);font-family:system-ui,sans-serif;">
        <h1 style="margin:0 0 16px;font-size:1.5rem;">Campaign Builder</h1>
        <p style="color:#666;margin:0 0 16px;">JavaScript is disabled or failed to load. Use the form below to sign in, or enable JavaScript for the full experience.</p>
        <form action="/api/login" method="post" style="display:flex;flex-direction:column;gap:12px;">
            <input type="email" name="email" placeholder="Email" required style="padding:10px;border:1px solid #ccc;border-radius:6px;">
            <input type="password" name="password" placeholder="Password" required style="padding:10px;border:1px solid #ccc;border-radius:6px;">
            <button type="submit" style="padding:10px;background:#4f46e5;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Sign in</button>
        </form>
    </div>
</noscript>
<div class="bg-white" id="authApp">
    <!-- Hero banner -->
    <div class="relative h-[150px]">
        <div class="absolute inset-0">
            <img class="w-full h-full object-cover" 
                 src="https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80" 
                 alt="Marketing background">
            <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-indigo-600 mix-blend-multiply"></div>
        </div>
        
        <div class="relative max-w-7xl mx-auto py-4 px-4">
            <h1 class="text-4xl font-extrabold tracking-tight text-white sm:text-5xl lg:text-6xl">
                Campaign Builder
            </h1>
            <p class="mt-2 text-lg text-indigo-100 max-w-3xl">
                Transform your marketing with AI-powered voice campaigns, SMS, and email - all in one professional platform
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="lg:grid lg:grid-cols-2 lg:gap-8 lg:items-center">
            <!-- Left side: Features -->
            <div class="relative">
                <h2 class="text-2xl font-extrabold text-gray-900 tracking-tight sm:text-3xl mb-6">
                    {{ isLogin ? 'Start Your Campaign Today!' : 'Start Your Campaign Today!' }}
                </h2>
                
                <dl class="mt-10 space-y-10">
                    <div class="relative">
                        <dt>
                            <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </div>
                            <p class="ml-16 text-lg leading-6 font-medium text-gray-900">AI Voice Calling ⭐</p>
                        </dt>
                        <dd class="mt-2 ml-16 text-base text-gray-500">
                            Set up automated voice campaigns in under 2 minutes. Professional voices in 14+ languages with auto-translation, interactive responses, and real-time monitoring.
                        </dd>
                    </div>

                    <div class="relative">
                        <dt>
                            <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-4 4z"></path>
                                </svg>
                            </div>
                            <p class="ml-16 text-lg leading-6 font-medium text-gray-900">SMS Marketing</p>
                        </dt>
                        <dd class="mt-2 ml-16 text-base text-gray-500">
                            Reach your customers instantly with our powerful SMS platform. Send personalized messages, schedule campaigns, and track delivery status in real-time.
                        </dd>
                    </div>

                    <div class="relative">
                        <dt>
                            <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <p class="ml-16 text-lg leading-6 font-medium text-gray-900">Email Campaigns</p>
                        </dt>
                        <dd class="mt-2 ml-16 text-base text-gray-500">
                            Create beautiful email campaigns with our easy-to-use templates. Design professional emails with our drag-and-drop editor and AI-powered content generation.
                        </dd>
                    </div>

                    <div class="relative">
                        <dt>
                            <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                            </div>
                            <p class="ml-16 text-lg leading-6 font-medium text-gray-900">Enterprise-Grade Security</p>
                        </dt>
                        <dd class="mt-2 ml-16 text-base text-gray-500">
                            Two-factor authentication, AES-256-GCM encryption, role-based access control, and data isolation. Your campaigns and contacts are protected with bank-level security.
                        </dd>
                    </div>

                    <div class="relative">
                        <dt>
                            <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <p class="ml-16 text-lg leading-6 font-medium text-gray-900">Team Collaboration</p>
                        </dt>
                        <dd class="mt-2 ml-16 text-base text-gray-500">
                            Multi-user accounts with role-based permissions. Manage unlimited contacts, create custom groups, and collaborate with your team - all included with your subscription.
                        </dd>

                        <br>
                        <button @click="toggleForm" class="mt-4 bg-indigo-600 text-white px-6 py-3 rounded-lg text-lg font-medium hover:bg-indigo-700">
                            {{ isLogin ? 'Start Your Campaign Today' : 'Already have an account? Sign in' }}
                        </button>

                    </div>
                </dl>
            </div>

            <!-- Right side: Auth Form -->
            <div class="mt-10 lg:mt-0 bg-white rounded-lg shadow-xl p-8">
                <div class="max-w-md mx-auto">
                    <h2 class="text-center text-3xl font-extrabold text-gray-900 mb-8">
                        {{ isLogin ? (isResetPassword ? 'Reset your password' : 'Sign in to your account') : 'Create your account' }}
                    </h2>
                    
                    <!-- Password Reset Form -->
                    <div v-if="isResetPassword" class="space-y-6">
                        <div class="text-center mb-6">
                            <p class="text-sm text-gray-600">
                                We've sent a verification code to <strong>{{ resetEmail }}</strong>
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Verification Code *</label>
                            <input v-model="resetCode" 
                                   type="text" 
                                   required 
                                   placeholder="Enter the verification code"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">New Password *</label>
                            <div class="mt-1 relative" style="position: relative !important;">
                                <input v-model="newPassword" 
                                       :type="showNewPassword ? 'text' : 'password'"
                                       required 
                                       @input="validateNewPassword"
                                       class="block w-full px-3 py-2 pr-12 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                       style="padding-right: 3rem !important;">
                                <button @click="showNewPassword = !showNewPassword" 
                                        type="button"
                                        style="position: absolute !important; top: 50% !important; right: 0.75rem !important; transform: translateY(-50%) !important; z-index: 9999 !important; background: transparent !important; border: none !important; cursor: pointer !important; padding: 0.25rem !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                    <svg v-if="showNewPassword" class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem !important; height: 1.25rem !important;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                    </svg>
                                    <svg v-else class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem !important; height: 1.25rem !important;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Confirm New Password *</label>
                            <div class="mt-1 relative" style="position: relative !important;">
                                <input v-model="newPasswordConfirm" 
                                       :type="showNewPasswordConfirm ? 'text' : 'password'"
                                       required 
                                       @input="validateNewPassword"
                                       class="block w-full px-3 py-2 pr-12 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                       style="padding-right: 3rem !important;">
                                <button @click="showNewPasswordConfirm = !showNewPasswordConfirm" 
                                        type="button"
                                        style="position: absolute !important; top: 50% !important; right: 0.75rem !important; transform: translateY(-50%) !important; z-index: 9999 !important; background: transparent !important; border: none !important; cursor: pointer !important; padding: 0.25rem !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                    <svg v-if="showNewPasswordConfirm" class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem !important; height: 1.25rem !important;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                    </svg>
                                    <svg v-else class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem !important; height: 1.25rem !important;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                            <p v-if="newPasswordMismatch" class="mt-1 text-sm text-red-600">
                                Passwords do not match
                            </p>
                        </div>

                        <!-- New Password Requirements -->
                        <div v-if="newPassword" class="p-3 bg-gray-50 rounded-md border border-gray-200">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Password Requirements:</h4>
                            <ul class="text-xs space-y-1">
                                <li :class="newPasswordRequirements.length ? 'text-green-600 font-medium' : 'text-gray-500'">
                                    <span v-if="newPasswordRequirements.length" class="inline-block w-4">✓</span>
                                    <span v-else class="inline-block w-4">○</span>
                                    At least 8 characters
                                </li>
                                <li :class="newPasswordRequirements.uppercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                    <span v-if="newPasswordRequirements.uppercase" class="inline-block w-4">✓</span>
                                    <span v-else class="inline-block w-4">○</span>
                                    At least 1 uppercase letter
                                </li>
                                <li :class="newPasswordRequirements.lowercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                    <span v-if="newPasswordRequirements.lowercase" class="inline-block w-4">✓</span>
                                    <span v-else class="inline-block w-4">○</span>
                                    At least 1 lowercase letter
                                </li>
                                <li :class="newPasswordRequirements.number ? 'text-green-600 font-medium' : 'text-gray-500'">
                                    <span v-if="newPasswordRequirements.number" class="inline-block w-4">✓</span>
                                    <span v-else class="inline-block w-4">○</span>
                                    At least 1 number
                                </li>
                                <li :class="newPasswordRequirements.special ? 'text-green-600 font-medium' : 'text-gray-500'">
                                    <span v-if="newPasswordRequirements.special" class="inline-block w-4">✓</span>
                                    <span v-else class="inline-block w-4">○</span>
                                    At least 1 special character (!@#$%^&*)
                                </li>
                            </ul>
                        </div>

                        <div class="space-y-3">
                            <button @click="resetPassword" 
                                    :disabled="!isResetFormValid"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                                Reset Password
                            </button>
                            
                            <button @click="cancelReset" 
                                    type="button"
                                    class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Back to Sign In
                            </button>
                        </div>
                    </div>
                    
                    <!-- Regular Login/Register Form -->
                    <div v-else class="space-y-6">
                        <div v-if="!isLogin">
                            <!-- Company Information -->
                            <div class="space-y-4 mb-6">
                                <h3 class="text-lg font-medium text-gray-900">Company Information</h3>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Company Name *</label>
                                    <input v-model="company.name" 
                                           type="text" 
                                           required 
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>

                                <!-- Address Fields -->
                                <div class="space-y-4">
                                    <label class="block text-sm font-medium text-gray-700">Address *</label>
                                    
                                    <div>
                                        <input v-model="company.address.street" 
                                               type="text" 
                                               required 
                                               placeholder="Street Address"
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>

                                    <div>
                                        <input v-model="company.address.unit" 
                                               type="text" 
                                               placeholder="Apartment, suite, unit, etc. (optional)"
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <input v-model="company.address.city" 
                                                   type="text" 
                                                   required 
                                                   placeholder="City"
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <div>
                                            <input v-model="company.address.province" 
                                                   type="text" 
                                                   required 
                                                   placeholder="Province"
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <input v-model="company.address.postalCode" 
                                                   type="text" 
                                                   required 
                                                   placeholder="Postal Code"
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <div>
                                            <input v-model="company.address.country" 
                                                   type="text" 
                                                   required 
                                                   placeholder="Country"
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Phone Number *</label>
                                    <div class="mt-1 relative">
                                        <input v-model="company.phone" 
                                               type="tel" 
                                               required 
                                               placeholder="(123) 456-7890"
                                               @input="formatPhoneNumber"
                                               :class="{
                                                   'border-red-300 focus:ring-red-500 focus:border-red-500': company.phone && !validatePhoneNumber(company.phone),
                                                   'border-gray-300 focus:ring-indigo-500 focus:border-indigo-500': !company.phone || validatePhoneNumber(company.phone)
                                               }"
                                               class="block w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-2">
                                        <p v-if="company.phone && !validatePhoneNumber(company.phone)" class="mt-1 text-sm text-red-600">
                                            Please enter a valid 10-digit phone number
                                        </p>
                                        <p v-else class="mt-1 text-sm text-gray-500">This number will be used for account verification and security</p>
                                    </div>
                                </div>

                                <!-- Verification Method Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">How would you like to verify your account? *</label>
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <input v-model="verificationMethod" 
                                                   type="radio" 
                                                   value="email" 
                                                   id="verify-email"
                                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                            <label for="verify-email" class="ml-3 block text-sm font-medium text-gray-700">
                                                <span class="flex items-center">
                                                    <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                    </svg>
                                                    Email verification
                                                </span>
                                                <span class="text-xs text-gray-500 ml-7">We'll send a verification link to your email address</span>
                                            </label>
                                        </div>
                                        <div class="flex items-center">
                                            <input v-model="verificationMethod" 
                                                   type="radio" 
                                                   value="sms" 
                                                   id="verify-sms"
                                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                            <label for="verify-sms" class="ml-3 block text-sm font-medium text-gray-700">
                                                <span class="flex items-center">
                                                    <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                                    </svg>
                                                    SMS verification
                                                </span>
                                                <span class="text-xs text-gray-500 ml-7">We'll send a verification code to your phone number</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information -->
                        <div class="space-y-4">
                            <h3 v-if="!isLogin" class="text-lg font-medium text-gray-900">Account Information</h3>
                            
                            <div v-if="!isLogin">
                                <label class="block text-sm font-medium text-gray-700">Username</label>
                                <input v-model="username" 
                                       type="text" 
                                       placeholder="Choose a username (optional)"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <p class="mt-1 text-sm text-gray-500">Username is optional but helps with account identification</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email address *</label>
                                <input v-model="email" 
                                       type="email" 
                                       required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">Password *</label>
                                
                                <!-- Security Tip - Only show for registration -->
                                <div v-if="!isLogin" class="mt-1 mb-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 mt-0.5">
                                            <svg class="h-4 w-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-2">
                                            <p class="text-xs text-blue-700 leading-relaxed">
                                                <span class="font-medium">Security Tip:</span> Choose a strong password with uppercase, lowercase, numbers, and special characters.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-1 relative" style="position: relative !important;">
                                    <input v-model="password" 
                                           :type="showPassword ? 'text' : 'password'"
                                           required 
                                           @input="validatePassword"
                                           class="block w-full px-3 py-2 pr-12 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                           style="padding-right: 3rem !important;">
                                    <button @click="showPassword = !showPassword" 
                                            type="button"
                                            style="position: absolute !important; top: 50% !important; right: 0.75rem !important; transform: translateY(-50%) !important; z-index: 9999 !important; background: transparent !important; border: none !important; cursor: pointer !important; padding: 0.25rem !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                        <svg v-if="showPassword" class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem !important; height: 1.25rem !important;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                        </svg>
                                        <svg v-else class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem !important; height: 1.25rem !important;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Forgot Password Link - Only show for login -->
                                <div v-if="isLogin && !show2FAPrompt" class="mt-2 text-right">
                                    <button @click="forgotPassword" 
                                            type="button"
                                            class="text-sm text-indigo-600 hover:text-indigo-500 font-medium">
                                        Forgot your password?
                                    </button>
                                </div>
                            </div>

                            <!-- Account Verification Code Field - Show when account verification is required -->
                            <div v-if="isLogin && showVerificationCodeInput" class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-green-800">Account Verification Required</h3>
                                        <p class="text-sm text-green-600">Enter the verification code sent to your phone to complete registration</p>
                                    </div>
                                </div>
                                <div class="mt-1">
                                    <input v-model="verificationCode" 
                                           type="text" 
                                           placeholder="A1b2C3"
                                           maxlength="7"
                                           required
                                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-center font-mono text-lg">
                                </div>
                                <div class="mt-4">
                                    <button @click="verifyAccount" 
                                            type="button"
                                            :disabled="!verificationCode || verificationCode.length < 5"
                                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                        ✓ Verify Account
                                    </button>
                                </div>
                                <div class="mt-2 text-center">
                                    <button @click="cancelVerificationCode" 
                                            type="button"
                                            class="text-sm text-gray-600 hover:text-gray-800 underline">
                                        Back to login
                                    </button>
                                </div>
                            </div>

                            <!-- 2FA Code Field - Only show when 2FA is required for login -->
                            <div v-if="isLogin && show2FAPrompt" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-blue-800">Two-Factor Authentication Required</h3>
                                        <p class="text-sm text-blue-600">Enter the 6-digit code sent to your device</p>
                                    </div>
                                </div>
                                <div class="mt-1">
                                    <input v-model="twoFactorCode" 
                                           type="text" 
                                           placeholder="123456"
                                           maxlength="6"
                                           required
                                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-center font-mono text-lg">
                                </div>
                                <div class="mt-3 flex justify-between items-center">
                                    <button @click="cancel2FAPrompt" 
                                            type="button"
                                            class="text-sm text-gray-600 hover:text-gray-800">
                                        Back to login
                                    </button>
                                    <button @click="requestNew2FACode" 
                                            type="button"
                                            :disabled="isRequesting2FACode"
                                            class="text-sm text-indigo-600 hover:text-indigo-800 disabled:opacity-50">
                                        {{ isRequesting2FACode ? 'Sending...' : 'Send new code' }}
                                    </button>
                                </div>
                            </div>

                            <!-- 2FA Setup Prompt - Show when user logs in for the first time -->
                            <div v-if="isLogin && show2FASetupPrompt && !show2FASetupVerification">
                                <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                                    <div class="flex items-start">
                                        <svg class="h-6 w-6 text-blue-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <h3 class="text-sm font-medium text-blue-900 mb-2">Secure Your Account with 2FA</h3>
                                            <p class="text-sm text-blue-800 mb-4">
                                                We recommend enabling Two-Factor Authentication to add an extra layer of security to your account. Choose your preferred method:
                                            </p>
                                            
                                            <div class="space-y-3 mb-4">
                                                <div class="flex items-start p-3 border border-blue-300 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors" 
                                                     @click="selected2FAMethod = 'email'">
                                                    <input type="radio" 
                                                           v-model="selected2FAMethod" 
                                                           value="email" 
                                                           id="setup-email-2fa" 
                                                           class="mt-1 mr-3">
                                                    <label for="setup-email-2fa" class="flex-1 cursor-pointer">
                                                        <div class="flex items-center text-sm font-medium text-blue-900 mb-1">
                                                            <svg class="h-5 w-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                            </svg>
                                                            Email Verification
                                                        </div>
                                                        <p class="text-xs text-blue-700 ml-7">Get verification codes sent to your email address</p>
                                                    </label>
                                                </div>
                                                
                                                <div class="flex items-start p-3 border border-blue-300 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors" 
                                                     @click="selected2FAMethod = 'sms'">
                                                    <input type="radio" 
                                                           v-model="selected2FAMethod" 
                                                           value="sms" 
                                                           id="setup-sms-2fa" 
                                                           class="mt-1 mr-3">
                                                    <label for="setup-sms-2fa" class="flex-1 cursor-pointer">
                                                        <div class="flex items-center text-sm font-medium text-blue-900 mb-1">
                                                            <svg class="h-5 w-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                            </svg>
                                                            SMS Verification
                                                        </div>
                                                        <p class="text-xs text-blue-700 ml-7">Get codes via text message - Uses system messaging (no phone number purchase required)</p>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="flex flex-col sm:flex-row gap-3">
                                                <button @click="accept2FASetup" 
                                                        :disabled="!selected2FAMethod"
                                                        class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold text-base shadow-md hover:shadow-lg transition-all duration-200">
                                                    Enable 2FA
                                                </button>
                                                <button @click="decline2FASetup" 
                                                        class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-300 font-semibold text-base shadow-md hover:shadow-lg transition-all duration-200">
                                                    Not Now
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2FA Setup Verification - Show when user is setting up 2FA -->
                            <div v-if="isLogin && show2FASetupVerification">
                                <div class="border border-green-200 rounded-lg p-4 bg-green-50">
                                    <h3 class="text-sm font-medium text-green-900 mb-2">Enter Verification Code</h3>
                                    <p class="text-sm text-green-800 mb-4">{{ setup2FAMessage }}</p>
                                    
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <input v-model="twoFactorCode" 
                                               type="text" 
                                               placeholder="123456"
                                               maxlength="6"
                                               required
                                               class="flex-1 px-3 py-2 border border-green-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-center font-mono text-lg">
                                        <button @click="verify2FASetup" 
                                                :disabled="!twoFactorCode || twoFactorCode.length !== 6"
                                                class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 disabled:opacity-50 font-medium text-sm">
                                            Verify & Enable
                                        </button>
                                    </div>
                                    
                                    <div class="flex justify-between mt-3 text-sm">
                                        <button @click="resend2FASetupCode" 
                                                class="text-green-600 hover:text-green-500 font-medium">
                                            Resend code
                                        </button>
                                        <button @click="cancel2FASetup" 
                                                class="text-gray-600 hover:text-gray-500 font-medium">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                                                                <!-- Password Requirements -->
                                <div v-if="!isLogin && password" class="mt-2 p-3 bg-gray-50 rounded-md border border-gray-200">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Password Requirements:</h4>
                                    <ul class="text-xs space-y-1">
                                        <li :class="passwordRequirements.length ? 'text-green-600 font-medium' : 'text-gray-500'">
                                            <span v-if="passwordRequirements.length" class="inline-block w-4">✓</span>
                                            <span v-else class="inline-block w-4">○</span>
                                            At least 8 characters
                                        </li>
                                        <li :class="passwordRequirements.uppercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                            <span v-if="passwordRequirements.uppercase" class="inline-block w-4">✓</span>
                                            <span v-else class="inline-block w-4">○</span>
                                            At least 1 uppercase letter
                                        </li>
                                        <li :class="passwordRequirements.lowercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                            <span v-if="passwordRequirements.lowercase" class="inline-block w-4">✓</span>
                                            <span v-else class="inline-block w-4">○</span>
                                            At least 1 lowercase letter
                                        </li>
                                        <li :class="passwordRequirements.number ? 'text-green-600 font-medium' : 'text-gray-500'">
                                            <span v-if="passwordRequirements.number" class="inline-block w-4">✓</span>
                                            <span v-else class="inline-block w-4">○</span>
                                            At least 1 number
                                        </li>
                                        <li :class="passwordRequirements.special ? 'text-green-600 font-medium' : 'text-gray-500'">
                                            <span v-if="passwordRequirements.special" class="inline-block w-4">✓</span>
                                            <span v-else class="inline-block w-4">○</span>
                                            At least 1 special character (!@#$%^&*)
                                        </li>
                                    </ul>
                                    <div v-if="passwordStrength" class="mt-2 pt-2 border-t border-gray-200">
                                        <span class="text-xs font-medium text-gray-700">Strength: </span>
                                        <span :class="{
                                            'text-red-600 font-medium': passwordStrength === 'weak',
                                            'text-yellow-600 font-medium': passwordStrength === 'medium',
                                            'text-green-600 font-medium': passwordStrength === 'strong'
                                        }" class="text-xs">{{ passwordStrength }}</span>
                                    </div>
                                    
                                    <!-- Password Generator Suggestion -->
                                    <div v-if="!isPasswordValid && password" class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs">
                                        <p class="text-yellow-800 mb-1 font-medium">Need help?</p>
                                        <p class="text-yellow-700 mb-1">Try a password like: <code class="bg-yellow-100 px-1 py-0.5 rounded font-mono text-xs">MySecure!2024</code></p>
                                        <p class="text-yellow-600 text-xs">This example meets all requirements: uppercase, lowercase, number, and special character.</p>
                                    </div>
                                </div>
                            </div>

                            <div v-if="!isLogin">
                                <label class="block text-sm font-medium text-gray-700">Confirm Password *</label>
                                <input v-model="passwordConfirm" 
                                       type="password" 
                                       required 
                                       @input="validatePassword"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <p v-if="passwordMismatch" class="mt-1 text-sm text-red-600">
                                    Passwords do not match
                                </p>
                            </div>
                        </div>

                        <div>
                            <button @click="submitForm" 
                                    :disabled="(!isLogin && (passwordMismatch || !isFormValid)) || showVerificationCodeInput || isSubmitting"
                                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 touch-manipulation"
                                    style="min-height: 44px;">
                                {{ isLogin ? 'Sign in' : 'Start Your Campaign Today' }}
                            </button>
                        </div>

                        <div class="text-center text-sm">
                            <a @click="toggleForm" 
                               class="cursor-pointer font-medium text-indigo-600 hover:text-indigo-500">
                                {{ isLogin ? 'Need an account? Register' : 'Already have an account? Sign in' }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // iPad/iOS specific optimizations
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        
        // Prevent zoom on input focus
        const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], input[type="tel"]');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                // Ensure font size is at least 16px to prevent zoom
                if (parseInt(window.getComputedStyle(this).fontSize) < 16) {
                    this.style.fontSize = '16px';
                }
            });
        });
        
        // Improve touch handling
        document.body.style.touchAction = 'manipulation';
        
        // Fix iOS Safari viewport issues
        const viewport = document.querySelector('meta[name="viewport"]');
        if (viewport) {
            viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        }
    }
    
    if (typeof Vue === 'undefined') {
        console.error('Vue.js is not loaded!');
        return;
    }

    const { createApp } = Vue;

    const app = createApp({
    data() {
        return {
            isLogin: true,
            email: '',
            username: '',
            password: '',
            passwordConfirm: '',
            passwordRequirements: {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false,
                special: false
            },
            passwordStrength: '',
            company: {
                name: '',
                phone: '',
                address: {
                    street: '',
                    unit: '',
                    city: '',
                    province: '',
                    postalCode: '',
                    country: ''
                }
            },
            verificationMethod: 'email', // Default to email verification
            // Verification code data
            showVerificationCodeInput: false,
            verificationCode: '',
            isSubmitting: false,
            justRegistered: false,
            // 2FA login data
            show2FAPrompt: false,
            twoFactorCode: '',
            twoFactorMessage: '',
            twoFactorMethod: '',
            isRequesting2FACode: false,
            // 2FA setup prompt data
            show2FASetupPrompt: false,
            available2FAMethods: { email: false, sms: false },
            selected2FAMethod: '',
            setup2FAMessage: '',
            show2FASetupVerification: false,
            isResetPassword: false,
            resetEmail: '',
            resetCode: '',
            newPassword: '',
            newPasswordConfirm: '',
            newPasswordRequirements: {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false,
                special: false
            },
            newPasswordStrength: '',
            newPasswordMismatch: false,
            showPassword: false,
            showNewPassword: false,
            showNewPasswordConfirm: false,
            // Subscription info display
            subscriptionInfo: null,
            subscriptionMessage: '',
            isProcessingPayment: false,
            // Stripe properties
            stripe: null,
            cardElement: null,
            // User type
            userType: null
        }
    },
    computed: {
        passwordMismatch() {
            return this.password !== this.passwordConfirm && this.passwordConfirm !== '';
        },
        isPasswordValid() {
            return this.passwordRequirements.length && 
                   this.passwordRequirements.uppercase && 
                   this.passwordRequirements.lowercase && 
                   this.passwordRequirements.number && 
                   this.passwordRequirements.special;
        },
        isFormValid() {
            if (this.isLogin) return true;
            return this.email && 
                   this.password && 
                   this.passwordConfirm && 
                   !this.passwordMismatch && 
                   this.isPasswordValid &&
                   this.company.name && 
                   this.company.phone &&
                   this.validatePhoneNumber(this.company.phone) &&
                   this.company.address.street &&
                   this.company.address.city &&
                   this.company.address.province &&
                   this.company.address.postalCode &&
                   this.company.address.country;
        },
        isResetFormValid() {
            return this.resetCode && 
                   this.newPassword && 
                   this.newPasswordConfirm && 
                   !this.newPasswordMismatch && 
                   this.isNewPasswordValid;
        },
        isNewPasswordValid() {
            return this.newPasswordRequirements.length && 
                   this.newPasswordRequirements.uppercase && 
                   this.newPasswordRequirements.lowercase && 
                   this.newPasswordRequirements.number && 
                   this.newPasswordRequirements.special;
        },
        newPasswordMismatch() {
            return this.newPassword !== this.newPasswordConfirm && this.newPasswordConfirm !== '';
        }
    },
    methods: {
        validatePassword() {
            if (!this.password) {
                this.passwordRequirements = {
                    length: false,
                    uppercase: false,
                    lowercase: false,
                    number: false,
                    special: false
                };
                this.passwordStrength = '';
                return;
            }

            // Check password requirements
            this.passwordRequirements = {
                length: this.password.length >= 8,
                uppercase: /[A-Z]/.test(this.password),
                lowercase: /[a-z]/.test(this.password),
                number: /[0-9]/.test(this.password),
                special: /[!@#$%^&*]/.test(this.password)
            };

            // Calculate password strength
            const requirementsMet = Object.values(this.passwordRequirements).filter(Boolean).length;
            if (requirementsMet <= 2) {
                this.passwordStrength = 'weak';
            } else if (requirementsMet <= 4) {
                this.passwordStrength = 'medium';
            } else {
                this.passwordStrength = 'strong';
            }
        },

        async submitForm() {
            // Prevent double submission
            if (this.isSubmitting) {
                return;
            }
            
            if (!this.isLogin && !this.isFormValid) return;
            
            // Don't submit form if verification code input is showing
            if (this.showVerificationCodeInput) {
                this.showError('Please enter the verification code first.');
                return;
            }
            
            // Don't submit form if we're in the middle of processing verification
            if (this.isLogin && this.email && !this.password) {
                return;
            }
            
            // Don't submit form if we just completed registration and are waiting for verification
            if (this.justRegistered) {
                return;
            }
            
            // Don't submit form if we're in login mode but still have company data (indicating we just registered)
            if (this.isLogin && this.company && this.company.name) {
                return;
            }
            
            this.isSubmitting = true;
            const endpoint = this.isLogin ? '/api/login' : '/api/register';
            try {
                const requestBody = {
                    email: this.email,
                    password: this.password
                };
                
                // Include 2FA code if login and 2FA is required
                if (this.isLogin && this.show2FAPrompt && this.twoFactorCode) {
                    requestBody.twoFactorCode = this.twoFactorCode;
                }
                
                // Only include company data for registration
                if (!this.isLogin) {
                    // Clean phone number before sending
                    const cleanPhone = this.company.phone.replace(/\D/g, '');
                    requestBody.company = {
                        ...this.company,
                        phone: cleanPhone
                    };
                    requestBody.username = this.username;
                    requestBody.verificationMethod = this.verificationMethod;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok) {
                    // Check if 2FA setup is being prompted
                    if (this.isLogin && data.prompt2FASetup) {
                        this.show2FASetupPrompt = true;
                        this.available2FAMethods = data.available2FAMethods;
                        this.selected2FAMethod = data.available2FAMethods.email ? 'email' : 'sms';
                        // Don't return here - let the login complete
                    } else if (this.isLogin) {
                        // Use server's redirect response instead of hardcoded dashboard
                        // Store token for fallback cookie setting
                        if (data.token) {
                            localStorage.setItem('token', data.token);
                        }
                        
                        if (data.redirectTo) {
                            // Add longer delay for mobile devices to ensure cookies are set properly
                            setTimeout(() => {
                                this.performRedirectWithCookieCheck(data.redirectTo);
                            }, 500);
                        } else {
                            // Fallback to dashboard if no redirect specified
                            setTimeout(() => {
                                this.performRedirectWithCookieCheck('/dashboard');
                            }, 500);
                        }
                    } else {
                        // Set user type
                        this.userType = data.userType;
                        
                        // Check if verification is required
                        if (data.requiresVerification) {
                            // Show verification message and switch to login
                            this.showError(data.message, 'success');
                            this.isLogin = true;
                            this.justRegistered = true;
                            
                            // Show verification code input if SMS was used
                            if (data.verificationMethod === 'sms') {
                                this.showVerificationCodeInput = true;
                                this.verificationMethod = 'sms';
                                
                                // Force a re-render to ensure the UI updates
                                this.$nextTick(() => {
                                    // UI updated
                                });
                                // Don't clear the email field so user can verify
                                this.password = '';
                                this.company = {
                                    name: '',
                                    phone: '',
                                    address: {
                                        street: '',
                                        unit: '',
                                        city: '',
                                        province: '',
                                        postalCode: '',
                                        country: ''
                                    }
                                };
                            } else {
                                // Clear form data for email verification
                                this.email = '';
                                this.password = '';
                                this.company = {
                                    name: '',
                                    phone: '',
                                    address: {
                                        street: '',
                                        unit: '',
                                        city: '',
                                        province: '',
                                        postalCode: '',
                                        country: ''
                                    }
                                };
                            }
                        } else if (data.subscriptionInfo) {
                            // Only show subscription if verification is complete
                            this.showSubscriptionInfo(data.subscriptionInfo, data.message);
                        } else {
                            alert('Registration successful! Please check your email to verify your account.');
                        }
                    }
                } else {
                    // Check if verification is required
                    if (this.isLogin && data.requiresVerification) {
                        this.showError(data.error, 'error');
                        // Show verification code input for SMS verification
                        if (data.verificationMethod === 'sms') {
                            this.showVerificationCodeInput = true;
                            this.verificationMethod = 'sms';
                        }
                        return;
                    }
                    
                    // Redirect based on server response
                    if (this.isLogin && data.redirectTo) {
                        this.showError(data.message, 'success');
                        this.confirmCookieThenRedirect(data.redirectTo);
                        return;
                    }
                    
                    // Check if 2FA is required
                    if (this.isLogin && data.requires2FA) {
                        this.show2FAPrompt = true;
                        this.twoFactorCode = '';
                        this.twoFactorMethod = data.twoFactorMethod;
                        
                        // Automatically request a 2FA code
                        await this.requestNew2FACode();
                        return;
                    }
                    
                    // Show specific error message instead of generic alert
                    this.showError(data.error);
                }
            } catch (error) {
                this.showError('An error occurred. Please try again.');
            } finally {
                this.isSubmitting = false;
            }
        },
        
        showError(message, type = 'error') {
            // Create a user-friendly message display
            const isSuccess = type === 'success';
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-3 rounded z-50 max-w-md ${
                isSuccess 
                    ? 'bg-green-100 border border-green-400 text-green-700' 
                    : 'bg-red-100 border border-red-400 text-red-700'
            }`;
            
            const iconPath = isSuccess
                ? 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z'
                : 'M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z';
            
            const buttonColor = isSuccess ? 'text-green-500 hover:text-green-700' : 'text-red-500 hover:text-red-700';
            
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path>
                    </svg>
                    <span class="font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto ${buttonColor}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        },
        
        async forgotPassword() {
            if (!this.email) {
                this.showError('Please enter your email address first.');
                return;
            }
            
            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: this.email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 max-w-md';
                    successDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">${data.message}</span>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-green-500 hover:text-green-700">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    document.body.appendChild(successDiv);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        if (successDiv.parentElement) {
                            successDiv.remove();
                        }
                    }, 5000);
                    
                    // Transition to reset password form
                    this.isResetPassword = true;
                    this.resetEmail = this.email;
                    this.email = ''; // Clear email field after successful reset request
                } else {
                    this.showError(data.error);
                }
            } catch (error) {
                this.showError('Failed to send reset code. Please try again.');
            }
        },

        async resetPassword() {
            if (!this.isResetFormValid) return;

            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: this.resetEmail,
                        code: this.resetCode,
                        newPassword: this.newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 max-w-md';
                    successDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">${data.message}</span>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-green-500 hover:text-green-700">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    document.body.appendChild(successDiv);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        if (successDiv.parentElement) {
                            successDiv.remove();
                        }
                    }, 5000);
                    
                    // Reset form and go back to login
                    this.cancelReset();
                } else {
                    this.showError(data.error);
                }
            } catch (error) {
                this.showError('Failed to reset password. Please try again.');
            }
        },

        validateNewPassword() {
            if (!this.newPassword) {
                this.newPasswordRequirements = {
                    length: false,
                    uppercase: false,
                    lowercase: false,
                    number: false,
                    special: false
                };
                this.newPasswordStrength = '';
                return;
            }

            // Check password requirements
            this.newPasswordRequirements = {
                length: this.newPassword.length >= 8,
                uppercase: /[A-Z]/.test(this.newPassword),
                lowercase: /[a-z]/.test(this.newPassword),
                number: /[0-9]/.test(this.newPassword),
                special: /[!@#$%^&*]/.test(this.newPassword)
            };

            // Calculate password strength
            const requirementsMet = Object.values(this.newPasswordRequirements).filter(Boolean).length;
            if (requirementsMet <= 2) {
                this.newPasswordStrength = 'weak';
            } else if (requirementsMet <= 4) {
                this.newPasswordStrength = 'medium';
            } else {
                this.newPasswordStrength = 'strong';
            }
        },

        cancelReset() {
            this.isResetPassword = false;
            this.resetEmail = '';
            this.resetCode = '';
            this.newPassword = '';
            this.newPasswordConfirm = '';
            this.newPasswordRequirements = {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false,
                special: false
            };
            this.newPasswordStrength = '';
            this.newPasswordMismatch = false;
            this.showNewPassword = false;
            this.showNewPasswordConfirm = false;
        },

        async requestNew2FACode() {
            this.isRequesting2FACode = true;
            try {
                const response = await fetch('/api/2fa/request-login-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: this.email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.twoFactorMessage = data.message;
                    this.showError(`Verification code sent! Check your ${data.method === 'sms' ? 'text messages' : 'email'}.`, 'success');
                } else {
                    this.showError(data.error);
                }
            } catch (error) {
                this.showError('Failed to send verification code. Please try again.');
            } finally {
                this.isRequesting2FACode = false;
            }
        },

        cancelVerificationCode() {
            this.showVerificationCodeInput = false;
            this.verificationCode = '';
        },

        showSubscriptionRequired(data) {
            // Show subscription required message and redirect to subscription page
            this.showError('Subscription required. Please complete your subscription to access the platform.', 'error');
            
            // Redirect to subscription page after a short delay
            setTimeout(() => {
                this.performRedirect('/subscription');
            }, 2000);
        },

        async verifyAccount() {
            if (!this.verificationCode || this.verificationCode.length < 5) {
                this.showError('Please enter a valid verification code.');
                return;
            }
            
            // Reset the justRegistered flag when user starts verification
            this.justRegistered = false;

            try {
                const response = await fetch('/api/verify-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: this.email,
                        code: this.verificationCode
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    this.showError('Account verified successfully! You can now log in.', 'success');
                    this.showVerificationCodeInput = false;
                    this.verificationCode = '';
                    // Clear the form
                    this.email = '';
                    this.password = '';
                } else {
                    this.showError(data.error || 'Invalid verification code. Please try again.');
                }
                
                // After successful verification, redirect to subscription page for trial users
                if (data.success) {
                    setTimeout(() => {
                        this.performRedirect('/subscription');
                    }, 1000);
                }
            } catch (error) {
                this.showError('An error occurred during verification. Please try again.');
            }
        },

        cancel2FAPrompt() {
            this.show2FAPrompt = false;
            this.twoFactorCode = '';
            this.twoFactorMessage = '';
            this.twoFactorMethod = '';
        },

        // 2FA Setup Methods
        async accept2FASetup() {
            if (!this.selected2FAMethod) return;
            
            try {
                const response = await fetch('/api/2fa/setup-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: this.email,
                        password: this.password,
                        accept: true,
                        method: this.selected2FAMethod
                    })
                });

                const data = await response.json();

                if (response.ok && data.setup2FA) {
                    this.show2FASetupPrompt = false;
                    this.show2FASetupVerification = true;
                    this.setup2FAMessage = data.message;
                    this.twoFactorCode = '';
                } else {
                    this.showError(data.error || 'Failed to initiate 2FA setup');
                }
            } catch (error) {
                this.showError('An error occurred setting up 2FA');
            }
        },

        async decline2FASetup() {
            try {
                const response = await fetch('/api/2fa/setup-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: this.email,
                        password: this.password,
                        accept: false
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const url = data.redirectTo || '/dashboard';
                    this.performRedirect(url);
                } else {
                    this.showError(data.error || 'Failed to process response');
                }
            } catch (error) {
                this.showError('An error occurred processing your response');
            }
        },

        async verify2FASetup() {
            if (!this.twoFactorCode || this.twoFactorCode.length !== 6) return;
            
            try {
                const response = await fetch('/api/2fa/verify-setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: this.email,
                        password: this.password,
                        code: this.twoFactorCode
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // 2FA setup complete, redirect to dashboard
                    this.showError('2FA enabled successfully! Welcome to Campaign Builder.', 'success');
                    setTimeout(() => {
                        this.performRedirect('/dashboard');
                    }, 1500);
                } else {
                    this.showError(data.error || 'Invalid verification code');
                }
            } catch (error) {
                console.error('2FA verification error:', error);
                this.showError('An error occurred verifying the code');
            }
        },

        async resend2FASetupCode() {
            await this.accept2FASetup();
        },

        cancel2FASetup() {
            this.show2FASetupPrompt = false;
            this.show2FASetupVerification = false;
            this.setup2FAMessage = '';
            this.twoFactorCode = '';
            this.selected2FAMethod = '';
        },

        showSubscriptionInfo(subscriptionInfo, message) {
            this.subscriptionInfo = subscriptionInfo;
            this.subscriptionMessage = message;
            
            // Check if user is a team member
            if (this.userType === 'team_member') {
                this.showTeamMemberMessage();
            } else {
                this.createSubscriptionModal();
            }
        },

        showTeamMemberMessage() {
            // Remove any existing modals
            this.removeExistingModals();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'team-member-modal';
            
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="mt-2 px-7 py-3">
                            <h3 class="text-lg font-medium text-gray-900 text-center">Welcome to the Team!</h3>
                            <div class="mt-2 px-1 py-3">
                                <p class="text-sm text-gray-500 text-center">You're a team member and have full access through your account holder's EDA status.</p>
                                <div class="mt-4 p-4 bg-blue-50 rounded-md">
                                    <h4 class="text-sm font-medium text-blue-900">Team Benefits:</h4>
                                    <ul class="mt-2 text-sm text-blue-700">
                                        <li>• Access to all team features</li>
                                        <li>• Shared contacts and campaigns</li>
                                        <li>• No payment required - EDA access</li>
                                        <li>• Full platform access</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="continue-team-btn" 
                                    class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                                Continue to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listener
            document.getElementById('continue-team-btn').addEventListener('click', () => {
                this.removeExistingModals();
                this.performRedirect('/dashboard');
            });
        },

        createSubscriptionModal() {
            // Remove any existing modals
            this.removeExistingModals();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'subscription-modal';
            
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div class="mt-2 px-7 py-3">
                            <h3 class="text-lg font-medium text-gray-900 text-center">Account Created Successfully!</h3>
                            <div class="mt-2 px-1 py-3">
                                <p class="text-sm text-gray-500 text-center">${this.subscriptionMessage}</p>
                            </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="start-subscription-btn" 
                                    class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                                Subscribe Now
                            </button>
                            <button id="cancel-subscription-btn" 
                                    class="mt-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('start-subscription-btn').addEventListener('click', () => {
                this.startSubscription();
            });
            
            document.getElementById('cancel-subscription-btn').addEventListener('click', () => {
                this.closeSubscriptionModal();
            });
        },

        closeSubscriptionModal() {
            this.removeExistingModals();
            this.subscriptionInfo = null;
            this.subscriptionMessage = '';
        },

        startSubscription() {
            this.removeExistingModals();
            this.createCreditCardModal();
        },

        async createCreditCardModal() {
            // Remove any existing modals
            this.removeExistingModals();
            
            // Billing is handled off-platform (Paddle); no Stripe
            if (!window.Stripe) {
                alert('Billing is handled off-platform. Please contact support to upgrade or manage your subscription.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'credit-card-modal';
            
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100">
                            <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-6 4h12a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="mt-2 px-7 py-3">
                            <h3 class="text-lg font-medium text-gray-900 text-center">Complete Your Subscription</h3>
                            <p class="text-sm text-gray-500 text-center mt-2">Enter your payment information to subscribe</p>
                        </div>
                        
                        <div class="px-4 py-3 space-y-4">
                            <!-- Stripe Card Element -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Card Information</label>
                                <div id="card-element" class="border rounded-md p-3"></div>
                                <div id="card-errors" class="text-red-600 text-sm mt-2"></div>
                            </div>

                            <!-- Pricing Info -->
                            <div class="bg-gray-50 p-4 rounded-md">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Monthly Subscription</span>
                                    <span class="text-lg font-bold text-indigo-600">$49.99/month</span>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-sm text-gray-500">Free Trial</span>
                                    <span class="text-sm text-green-600 font-medium">7 days free</span>
                                </div>
                                <div class="border-t border-gray-200 mt-2 pt-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-900">Total Today</span>
                                        <span class="text-sm text-gray-500">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="items-center px-4 py-3 space-y-3">
                            <button id="process-payment-btn" 
                                    class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300 disabled:opacity-50">
                                Subscribe Now
                            </button>
                            <button id="cancel-payment-btn" 
                                    class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-50">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize Stripe Elements
            this.initializeStripeElements();
            
            // Add event listeners
            document.getElementById('process-payment-btn').addEventListener('click', () => {
                this.processPayment();
            });
            
            document.getElementById('cancel-payment-btn').addEventListener('click', () => {
                this.cancelPayment();
            });
        },

        removeExistingModals() {
            const existingModal = document.getElementById('subscription-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const existingCreditModal = document.getElementById('credit-card-modal');
            if (existingCreditModal) {
                existingCreditModal.remove();
            }
            
            const existingTeamModal = document.getElementById('team-member-modal');
            if (existingTeamModal) {
                existingTeamModal.remove();
            }
        },

        async processPayment() {
            if (!this.stripe || !this.cardElement) {
                this.showError('Payment system not ready. Please try again.');
                return;
            }

            this.isProcessingPayment = true;
            
            // Update button text
            const processBtn = document.getElementById('process-payment-btn');
            if (processBtn) {
                processBtn.textContent = 'Processing...';
                processBtn.disabled = true;
            }
            
            try {
                // Create payment method from card element
                const { paymentMethod, error } = await this.stripe.createPaymentMethod({
                    type: 'card',
                    card: this.cardElement,
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Create subscription with payment method
                const response = await fetch('/api/subscription/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: this.email,
                        paymentMethodId: paymentMethod.id
                    }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.success) {
                        this.showError('Payment processed successfully! Your account is now active.', 'success');
                        this.removeExistingModals();
                        // Redirect to dashboard after successful payment
                        setTimeout(() => {
                            this.performRedirect('/dashboard');
                        }, 2000);
                    } else {
                        this.showError(data.error || 'Payment failed. Please try again.');
                    }
                } else {
                    this.showError(data.error || 'Payment failed. Please try again.');
                }
            } catch (error) {
                console.error('Payment error:', error);
                this.showError(error.message || 'An error occurred during payment. Please try again.');
            } finally {
                this.isProcessingPayment = false;
                if (processBtn) {
                    processBtn.textContent = 'Start Free Trial';
                    processBtn.disabled = false;
                }
            }
        },

        validateCreditCard(cardData) {
            return cardData.cardNumber && 
                   cardData.expiryDate && 
                   cardData.cvv && 
                   cardData.name && 
                   cardData.zipCode;
        },

        formatPhoneNumber() {
            // Remove all non-numeric characters
            let phone = this.company.phone.replace(/\D/g, '');
            
            // Limit to 10 digits
            if (phone.length > 10) {
                phone = phone.substring(0, 10);
            }
            
            // Format as (XXX) XXX-XXXX
            if (phone.length >= 6) {
                phone = `(${phone.substring(0, 3)}) ${phone.substring(3, 6)}-${phone.substring(6)}`;
            } else if (phone.length >= 3) {
                phone = `(${phone.substring(0, 3)}) ${phone.substring(3)}`;
            } else if (phone.length > 0) {
                phone = `(${phone}`;
            }
            
            this.company.phone = phone;
        },

        validatePhoneNumber(phone) {
            // Remove all non-numeric characters
            const cleanPhone = phone.replace(/\D/g, '');
            
            // Check if it's a valid 10-digit North American phone number
            if (cleanPhone.length !== 10) {
                return false;
            }
            
            // Check if it starts with a valid area code (not 0 or 1)
            const areaCode = cleanPhone.substring(0, 3);
            if (areaCode[0] === '0' || areaCode[0] === '1') {
                return false;
            }
            
            return true;
        },

        cancelPayment() {
            this.removeExistingModals();
        },

        async initializeStripeElements() {
            try {
                // Initialize Stripe
                this.stripe = Stripe('<%= STRIPE_PUBLIC_KEY %>');
                
                // Create card element
                const elements = this.stripe.elements();
                this.cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            '::placeholder': {
                                color: '#aab7c4'
                            }
                        },
                        invalid: {
                            color: '#fa755a',
                            iconColor: '#fa755a'
                        }
                    }
                });

                // Mount card element
                this.cardElement.mount('#card-element');

                // Handle card element changes
                this.cardElement.on('change', (event) => {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            } catch (error) {
                console.error('Error initializing Stripe Elements:', error);
                document.getElementById('card-errors').textContent = 'Error loading payment system. Please refresh and try again.';
            }
        },

        // Robust redirect function for new devices
        performRedirect(url) {
            // Try multiple redirect methods for better compatibility
            try {
                // Method 1: Direct assignment
                window.location.href = url;
            } catch (error) {
                console.error('Direct redirect failed:', error);
                try {
                    // Method 2: Using assign
                    window.location.assign(url);
                } catch (error2) {
                    console.error('Assign redirect failed:', error2);
                    try {
                        // Method 3: Using replace
                        window.location.replace(url);
                    } catch (error3) {
                        console.error('Replace redirect failed:', error3);
                        // Method 4: Manual navigation
                        document.location = url;
                    }
                }
            }
        },

        // Verify cookie is sent before redirecting to avoid login loop (dashboard → no cookie → /login?loop=1)
        async confirmCookieThenRedirect(url) {
            const path = (url && url.startsWith('/')) ? url : (url || '/dashboard');
            await new Promise(r => setTimeout(r, 800));
            try {
                const r = await fetch('/api/user', { method: 'GET', credentials: 'include' });
                if (r.ok) {
                    this.performRedirect(path);
                    return;
                }
                if (r.status === 401) {
                    this.showError('Session could not be established. Please try again or refresh the page.');
                    return;
                }
            } catch (e) {
                this.showError('Could not verify session. Please try again.');
                return;
            }
            this.performRedirect(path);
        },

        // Redirect after login; path-only keeps same origin
        performRedirectWithCookieCheck(url) {
            const path = (url && url.startsWith('/')) ? url : (url || '/dashboard');
            this.performRedirect(path);
        },

        toggleForm() {
            this.isLogin = !this.isLogin;
            if (this.isLogin) {
                this.company = {
                    name: '',
                    phone: '',
                    address: {
                        street: '',
                        unit: '',
                        city: '',
                        province: '',
                        postalCode: '',
                        country: ''
                    }
                };
                this.username = '';
                this.passwordConfirm = '';
                this.password = '';
                this.passwordRequirements = {
                    length: false,
                    uppercase: false,
                    lowercase: false,
                    number: false,
                    special: false
                };
                this.passwordStrength = '';
                
                // Reset 2FA state
                this.show2FAPrompt = false;
                this.twoFactorCode = '';
                this.twoFactorMessage = '';
                this.twoFactorMethod = '';
                // Reset 2FA setup state
                this.show2FASetupPrompt = false;
                this.show2FASetupVerification = false;
                this.setup2FAMessage = '';
                this.selected2FAMethod = '';
                this.available2FAMethods = { email: false, sms: false };
            }
        }
    }
    });

    app.mount('#authApp');
});
</script>
<!-- Proof: clear redirect lock and log client-side redirect when present -->
<script>
(function() {
    try {
        sessionStorage.removeItem('__cb_redirecting');
        sessionStorage.removeItem('__redirecting_to_login');
        sessionStorage.removeItem('__cb_last_redirect');
    } catch (e) {}
})();
</script>
</div>
</body>
</html> 