<% var isElectionAccount = (typeof isElectionAccount !== 'undefined' ? isElectionAccount : (typeof user !== 'undefined' && user && (user.electionMode || user.accountType === 'election'))); %>

<% if (isElectionAccount) { %>
<!-- Election layout: hero at top, then sidebar under header on left (lg+), hamburger on mobile -->
<style>
/* Force-hide mobile header and menu on large screens (sidebar visible) - works even if Tailwind responsive classes are missing */
@media (min-width: 1024px) {
    .election-mobile-header,
    .election-mobile-menu { display: none !important; }
}
</style>
<div class="flex flex-col min-h-screen bg-gray-100">
    <!-- Hero banner (full width) - always visible; on lg+ right side has user + help/profile/logout. mb-6 adds space below banner. -->
    <div class="relative flex-shrink-0 min-h-[150px] h-[150px] w-full overflow-hidden bg-indigo-700 mb-6">
        <div class="absolute inset-0">
            <img class="w-full h-full object-cover min-h-[150px]"
                 src="https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80"
                 alt="Marketing background">
            <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-indigo-600 mix-blend-multiply" aria-hidden="true"></div>
        </div>
        <div class="relative max-w-7xl mx-auto h-full px-4 flex flex-col justify-between">
            <div class="pt-4">
                <h1 class="text-lg sm:text-3xl font-extrabold tracking-tight text-white lg:text-4xl xl:text-5xl">Campaign Builder</h1>
                <p class="mt-1 sm:mt-2 text-xs sm:text-sm text-indigo-100 max-w-3xl">Your all-in-one platform for SMS and email marketing campaigns</p>
            </div>
            <div class="flex justify-end items-center flex-wrap" style="gap: 1.5rem; padding-bottom: 1.5rem;">
                <div id="userEmail" class="text-white text-xs sm:text-sm font-medium">
                    <% if (typeof user !== 'undefined' && user) { %>
                        <% var companyName = user.company && typeof user.company === 'object' ? user.company.name : (typeof user.company === 'string' ? user.company : null); %>
                        <% if (companyName && user.username) { %>Logged in as: <%= companyName %> (<%= user.username %>)
                        <% } else if (companyName) { %>Logged in as: <%= companyName %>
                        <% } else if (user.username) { %>Logged in as: <%= user.username %>
                        <% } else { %>Logged in as: <%= user.email %><% } %>
                        <% if (user.userType) { %>
                            <div class="mt-1">
                                <% if (user.userType === 'app_owner' || user.isAdmin === true) { %><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Admin</span>
                                <% } else if (user.userType === 'account_holder') { %><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">Account Holder</span>
                                <% } else if (user.userType === 'user' || user.userType === 'team_member') { %><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Team Member</span><% } %>
                            </div>
                        <% } %>
                    <% } %>
                </div>
                <!-- Help, profile, logout in hero on large screens only (when sidebar is visible) -->
                <div class="hidden lg:flex items-center flex-shrink-0" style="gap: 1.5rem;">
                    <button type="button" onclick="openHelpModal()" aria-label="Get help" class="p-2.5 rounded-full bg-white/25 text-white hover:bg-white hover:text-indigo-700 border border-white/40 transition-colors shadow-sm" title="Get Help">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </button>
                    <a href="/user-management" class="p-2.5 rounded-full bg-white/25 text-white hover:bg-white hover:text-indigo-700 border border-white/40 transition-colors shadow-sm" aria-label="Profile" title="Profile &amp; account settings"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></a>
                    <button type="button" onclick="logout()" class="px-5 py-2.5 text-sm font-semibold rounded-md shadow transition-colors" style="background-color:#dc2626;color:#fff;border:1px solid #b91c1c" onmouseover="this.style.backgroundColor='#b91c1c'" onmouseout="this.style.backgroundColor='#dc2626'" title="Log out">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Row: sidebar (left) + main content. On mobile: only mobile header + content -->
    <div class="flex flex-1 min-h-0">
        <!-- Left sidebar nav (lg+ only, fixed width so it never shrinks) -->
        <aside class="hidden lg:flex lg:flex-col w-64 min-w-[16rem] flex-shrink-0 bg-white border-r border-gray-200 shadow-sm" aria-label="Main navigation" style="width: 16rem;">
            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-0.5">
                <a href="/dashboard" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/dashboard' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Dashboard</a>
                <% if (!(user && (user.userType === 'app_owner' || user.isAdmin))) { %><a href="/teams" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/teams' || path.startsWith('/teams')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Teams</a><% } %>
                <a href="/contact-manager" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/contact-manager' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Contacts</a>
                <a href="/templates" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/templates' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Templates</a>
                <a href="/image-library" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/image-library' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Image Library</a>
                <a href="/messages" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/message') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Messages</a>
                <a href="/ai-calling" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/ai-calling' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">AI Calls</a>
                <a href="/election/lists" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/lists' || path.startsWith('/election/lists')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Lists</a>
                <a href="/election/navigation" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/navigation' || path.startsWith('/election/navigation')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Navigation</a>
                <a href="/election/interactions" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/interactions' || path.startsWith('/election/interactions')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Interactions</a>
                <a href="/election/scrutineering" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/scrutineering' || path.startsWith('/election/scrutineering')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Vote Tracking</a>
                <% if (user) { %>
                <a href="/requests" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/requests' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %> flex items-center justify-between">
                    <span>Requests</span>
                    <span class="nav-requests-badge ml-2 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;"><span class="nav-requests-count">0</span></span>
                </a>
                <% } %>
                <% if (user && (user.userType === 'app_owner' || (user.userType === 'account_holder' && user.isAdmin))) { %>
                <div class="pt-2 mt-2 border-t border-gray-200">
                    <p class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Admin</p>
                    <a href="/management" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/management' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">User Management</a>
                    <a href="/admin/help-tickets" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/help-tickets') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Help Requests</a>
                    <a href="/admin/audit-logs" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/audit-logs') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Audit Logs</a>
                    <a href="/admin/sender-settings" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/sender-settings') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Sender Settings (Email)</a>
                    <a href="/admin/phone-numbers" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/phone-numbers') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50' %>">Phone Numbers</a>
                </div>
                <% } %>
            </nav>
            <div class="p-4 border-t border-gray-200 space-y-2 flex-shrink-0">
                <span class="text-gray-600 text-xs block" id="tokenBalances">Loading...</span>
            </div>
        </aside>
        <!-- Main content area (do not close - page content follows; layout closes wrapper). No horizontal padding here so view body (max-w-7xl mx-auto px-4 sm:px-6 lg:px-8) defines width once = same as interactions view. -->
        <div class="flex-1 flex flex-col min-w-0 py-6" id="main-content">
            <!-- Mobile/small-screen only: hamburger + logo + help/profile/logout. Hidden on lg+ via CSS .election-mobile-header -->
            <header class="election-mobile-header bg-white shadow flex items-center justify-between h-14 px-4 mb-4 rounded-lg">
                <button type="button" onclick="toggleMobileMenu()" aria-label="Open menu" class="p-2 rounded-md text-gray-500 hover:bg-gray-100">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <span class="text-sm font-semibold text-indigo-600">Campaign Builder</span>
                <div class="flex items-center gap-1 sm:gap-2">
                    <%- include('_helpButton') %>
                    <a href="/user-management" class="p-1.5 text-gray-500 hover:text-gray-700" aria-label="Profile"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></a>
                    <button type="button" onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-medium px-3 py-1.5 rounded">Logout</button>
                </div>
            </header>
            <!-- Mobile/tablet menu (same links as sidebar). Hidden on lg+ via CSS .election-mobile-menu -->
            <div id="mobileMenu" class="election-mobile-menu hidden bg-white border-b border-gray-200 shadow mb-4" role="menu">
                <div class="px-4 py-3 space-y-1">
                    <a href="/dashboard" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/dashboard' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Dashboard</a>
                    <% if (!(user && (user.userType === 'app_owner' || user.isAdmin))) { %><a href="/teams" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/teams' || path.startsWith('/teams')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Teams</a><% } %>
                    <a href="/contact-manager" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/contact-manager' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Contacts</a>
                    <a href="/templates" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/templates' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Templates</a>
                    <a href="/image-library" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/image-library' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Image Library</a>
                    <a href="/messages" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/message') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Messages</a>
                    <a href="/ai-calling" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/ai-calling' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">AI Calls</a>
                    <a href="/election/lists" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/lists' || path.startsWith('/election/lists')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Lists</a>
                    <a href="/election/navigation" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/navigation' || path.startsWith('/election/navigation')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Navigation</a>
                    <a href="/election/interactions" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/interactions' || path.startsWith('/election/interactions')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Interactions</a>
                    <a href="/election/scrutineering" class="block px-3 py-2 rounded-md text-sm font-medium <%= (path === '/election/scrutineering' || path.startsWith('/election/scrutineering')) ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Vote Tracking</a>
                    <% if (user) { %><a href="/requests" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/requests' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %> flex items-center justify-between"><span>Requests</span><span class="nav-requests-badge ml-2 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;"><span class="nav-requests-count">0</span></span></a><% } %>
                    <% if (user && (user.userType === 'app_owner' || (user.userType === 'account_holder' && user.isAdmin))) { %>
                    <div class="pt-2 mt-2 border-t border-gray-200">
                        <p class="px-3 text-xs font-semibold text-gray-500 uppercase">Admin</p>
                        <a href="/management" class="block px-3 py-2 rounded-md text-sm font-medium <%= path === '/management' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">User Management</a>
                        <a href="/admin/help-tickets" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/help-tickets') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Help Requests</a>
                        <a href="/admin/audit-logs" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/audit-logs') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Audit Logs</a>
                        <a href="/admin/sender-settings" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/sender-settings') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Sender Settings (Email)</a>
                        <a href="/admin/phone-numbers" class="block px-3 py-2 rounded-md text-sm font-medium <%= path.startsWith('/admin/phone-numbers') ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700' %>">Phone Numbers</a>
                    </div>
                    <% } %>
            </div>
        </div>
        <!-- Page content follows (wrapper closed in layout.ejs) -->
<% } else { %>
<div>
    <!-- Hero banner -->
    <div class="relative h-[150px] mb-6">
        <div class="absolute inset-0">
            <img class="w-full h-full object-cover" 
                 src="https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80" 
                 alt="Marketing background">
            <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-indigo-600 mix-blend-multiply"></div>
        </div>
        
        <div class="relative max-w-7xl mx-auto h-full px-4 flex flex-col justify-between">
            <!-- Upper left: Title and subtitle -->
            <div class="pt-4">
                <h1 class="text-lg sm:text-3xl font-extrabold tracking-tight text-white lg:text-4xl xl:text-5xl">
                    Campaign Builder
                </h1>
                <p class="mt-1 sm:mt-2 text-xs sm:text-sm text-indigo-100 max-w-3xl">
                    Your all-in-one platform for SMS and email marketing campaigns
                </p>
            </div>
            
            <!-- Lower right: User info -->
            <div class="flex justify-end pb-4">
                <div id="userEmail" class="text-white text-xs sm:text-sm font-medium">
                    <% if (typeof user !== 'undefined' && user) { %>
                        <% var companyName = user.company && typeof user.company === 'object' ? user.company.name : (typeof user.company === 'string' ? user.company : null); %>
                        <% if (companyName && user.username) { %>
                            Logged in as: <%= companyName %> (<%= user.username %>)
                        <% } else if (companyName) { %>
                            Logged in as: <%= companyName %>
                        <% } else if (user.username) { %>
                            Logged in as: <%= user.username %>
                        <% } else { %>
                            Logged in as: <%= user.email %>
                        <% } %>
                        
                        <!-- User Type Indicator -->
                        <% if (user.userType) { %>
                            <div class="mt-1">
                                <% if (user.userType === 'app_owner') { %>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                        App Owner
                                    </span>
                                <% } else if (user.userType === 'account_holder') { %>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                        Account Holder
                                    </span>
                                <% } else if (user.userType === 'user' || user.userType === 'team_member') { %>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                        Team Member
                                    </span>
                                <% } %>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow mb-6" role="navigation" aria-label="Main navigation">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16" id="main-content">
                <!-- Desktop Menu (xl and up) - Only show for subscribed users -->
                <div class="hidden xl:flex space-x-8" id="main-nav-menu">
                    <a href="/dashboard" 
                       class="<%= path === '/dashboard' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Dashboard
                    </a>
                    <% if (!(user && (user.userType === 'app_owner' || user.isAdmin))) { %><a href="/teams" 
                       class="<%= path === '/teams' || path.startsWith('/teams') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Teams
                    </a><% } %>
                    <a href="/contact-manager" 
                       class="<%= path === '/contact-manager' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Contacts
                    </a>
                    <a href="/templates" 
                       class="<%= path === '/templates' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Templates
                    </a>
                    <a href="/image-library" 
                       class="<%= path === '/image-library' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Image Library
                    </a>
                    <a href="/messages" 
                       class="<%= path.startsWith('/message') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Messages
                    </a>
                    <a href="/ai-calling" 
                       class="<%= path === '/ai-calling' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        AI Calls
                    </a>
                    <% if (isElectionAccount) { %>
                    <a href="/election/lists" 
                       class="<%= path === '/election/lists' || path.startsWith('/election/lists') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Lists
                    </a>
                    <a href="/election/navigation" 
                       class="<%= path === '/election/navigation' || path.startsWith('/election/navigation') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Navigation
                    </a>
                    <a href="/election/interactions" 
                       class="<%= path === '/election/interactions' || path.startsWith('/election/interactions') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Interactions
                    </a>
                    <a href="/election/scrutineering" 
                       class="<%= path === '/election/scrutineering' || path.startsWith('/election/scrutineering') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Vote Tracking
                    </a>
                    <% } %>
                    <% if (user) { %>
                    <a href="/requests" 
                       class="<%= path === '/requests' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Requests
                        <span class="nav-requests-badge ml-1.5 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;"><span class="nav-requests-count">0</span></span>
                    </a>
                    <% } %>
                    <!-- Admin Menu - Inline with Dropdown -->
                    <% if (user && (user.userType === 'app_owner' || (user.userType === 'account_holder' && user.isAdmin))) { %>
                    <div class="relative inline-flex">
                        <a href="javascript:void(0)"
                           id="adminLink"
                           class="<%= path.startsWith('/admin') || path === '/management' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                                  inline-flex items-center px-1 pt-1 text-sm font-medium border-b-2"
                           onmouseenter="showAdminDropdown('desktop')"
                           onmouseleave="hideAdminDropdown('desktop')">
                            Admin
                            <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </a>
                        
                        <!-- Admin Dropdown Menu -->
                        <div role="menu" 
                             id="adminDropdownDesktop"
                             aria-labelledby="adminLink"
                             class="hidden absolute left-0 top-full mt-1 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50"
                             onmouseenter="showAdminDropdown('desktop')"
                             onmouseleave="hideAdminDropdown('desktop')">
                            <div class="py-1">
                                <div class="space-y-1">
                                    <a href="/management" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/management' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        User Management
                                    </a>
                                    <a href="/admin/help-tickets" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/help-tickets' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        <div class="flex items-center justify-between">
                                            <span>Help Requests</span>
                                            <span id="helpTicketsCountDesktop" class="ml-2 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;">
                                                <span id="helpTicketsCountNumberDesktop">0</span>
                                            </span>
                                        </div>
                                    </a>
                                    <a href="/admin/audit-logs" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/audit-logs' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        Audit Logs
                                    </a>
                                    <a href="/admin/sender-settings" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/sender-settings' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        Sender Settings (Email)
                                    </a>
                                    <a href="/admin/phone-numbers" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/phone-numbers' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        Phone Numbers
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>

                <!-- Tablet Menu (md to xl) - Only show for subscribed users -->
                <div class="hidden md:flex xl:hidden space-x-4" id="tablet-nav-menu">
                    <a href="/dashboard" 
                       class="<%= path === '/dashboard' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Dashboard
                    </a>
                    <% if (!(user && (user.userType === 'app_owner' || user.isAdmin))) { %><a href="/teams" 
                       class="<%= path === '/teams' || path.startsWith('/teams') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Teams
                    </a><% } %>
                    <a href="/contact-manager" 
                       class="<%= path === '/contact-manager' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Contacts
                    </a>
                    <a href="/templates" 
                       class="<%= path === '/templates' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Templates
                    </a>
                    <a href="/image-library" 
                       class="<%= path === '/image-library' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Image Library
                    </a>
                    <a href="/messages" 
                       class="<%= path.startsWith('/message') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Messages
                    </a>
                    <a href="/ai-calling" 
                       class="<%= path === '/ai-calling' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        AI Calls
                    </a>
                    <% if (isElectionAccount) { %>
                    <a href="/election/lists" 
                       class="<%= path === '/election/lists' || path.startsWith('/election/lists') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Lists
                    </a>
                    <a href="/election/navigation" 
                       class="<%= path === '/election/navigation' || path.startsWith('/election/navigation') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Navigation
                    </a>
                    <a href="/election/interactions" 
                       class="<%= path === '/election/interactions' || path.startsWith('/election/interactions') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Interactions
                    </a>
                    <a href="/election/scrutineering" 
                       class="<%= path === '/election/scrutineering' || path.startsWith('/election/scrutineering') ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Vote Tracking
                    </a>
                    <% } %>
                    <% if (user) { %>
                    <a href="/requests" 
                       class="<%= path === '/requests' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                              inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Requests
                        <span class="nav-requests-badge ml-1.5 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;"><span class="nav-requests-count">0</span></span>
                    </a>
                    <% } %>
                    <!-- Admin Menu - Inline with Dropdown -->
                    <% if (user && (user.userType === 'app_owner' || (user.userType === 'account_holder' && user.isAdmin))) { %>
                    <div class="relative inline-flex">
                        <a href="javascript:void(0)"
                           id="adminLinkTablet"
                           class="<%= path.startsWith('/admin') || path === '/management' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500' %> 
                                  inline-flex items-center px-1 pt-1 text-sm font-medium border-b-2"
                           onmouseenter="showAdminDropdown('tablet')"
                           onmouseleave="hideAdminDropdown('tablet')">
                            Admin
                            <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </a>
                        
                        <!-- Admin Dropdown Menu for Tablet -->
                        <div role="menu" 
                             id="adminDropdownTablet"
                             aria-labelledby="adminLinkTablet"
                             class="hidden absolute left-0 top-full mt-1 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50"
                             onmouseenter="showAdminDropdown('tablet')"
                             onmouseleave="hideAdminDropdown('tablet')">
                            <div class="py-1">
                                <div class="space-y-1">
                                    <a href="/management" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/management' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        User Management
                                    </a>
                                    <a href="/admin/help-tickets" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/help-tickets' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        <div class="flex items-center justify-between">
                                            <span>Help Requests</span>
                                            <span id="helpTicketsCountTablet" class="ml-2 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden">
                                                <span id="helpTicketsCountNumberTablet">0</span>
                                            </span>
                                        </div>
                                    </a>
                                    <a href="/admin/audit-logs" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/audit-logs' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        Audit Logs
                                    </a>
                                    <a href="/admin/sender-settings" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/sender-settings' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        Sender Settings (Email)
                                    </a>
                                    <a href="/admin/phone-numbers" 
                                       role="menuitem"
                                       class="block pl-3 pr-4 py-2 border-l-4 text-base font-medium
                                              <%= path === '/admin/phone-numbers' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                        Phone Numbers
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden flex items-center">
                    <button type="button" 
                            onclick="toggleMobileMenu()"
                            aria-expanded="false"
                            aria-controls="mobileMenu"
                            aria-label="Open main menu"
                            class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                        <span class="sr-only">Open main menu</span>
                        <svg class="h-6 w-6" 
                             fill="none" 
                             viewBox="0 0 24 24" 
                             stroke="currentColor"
                             aria-hidden="true">
                            <path stroke-linecap="round" 
                                  stroke-linejoin="round" 
                                  stroke-width="2" 
                                  d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>

                <!-- Right side items -->
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span class="text-gray-600 text-xs sm:text-sm" id="tokenBalances">
                        Loading...
                    </span>
                    
                    <!-- Help Button -->
                    <%- include('_helpButton') %>
                    
                    <a href="/user-management" 
                       aria-label="User profile and settings"
                       class="text-gray-600 hover:text-gray-800">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="sr-only">User profile</span>
                        </div>
                    </a>
                    
                    <button onclick="logout()" 
                            type="button"
                            aria-label="Logout from your account"
                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 sm:px-4 sm:py-2 rounded text-xs sm:text-sm">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden md:hidden" role="menu" aria-label="Mobile navigation menu">
                <div class="pt-2 pb-3 space-y-1">
                    <a href="/dashboard" 
                       class="<%= path === '/dashboard' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Dashboard
                    </a>
                    <% if (!(user && (user.userType === 'app_owner' || user.isAdmin))) { %><a href="/teams" 
                       class="<%= path === '/teams' || path.startsWith('/teams') ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Teams
                    </a><% } %>
                    <a href="/contact-manager" 
                       class="<%= path === '/contact-manager' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Contacts
                    </a>
                    <a href="/templates" 
                       class="<%= path === '/templates' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Templates
                    </a>
                    <a href="/image-library" 
                       class="<%= path === '/image-library' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Image Library
                    </a>
                    <a href="/messages" 
                       class="block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                              <%= path.startsWith('/message') ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                        Messages
                    </a>
                    <a href="/ai-calling" 
                       class="<%= path === '/ai-calling' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        AI Calls
                    </a>
                    <% if (isElectionAccount) { %>
                    <a href="/election/lists" 
                       class="<%= path === '/election/lists' || path.startsWith('/election/lists') ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Lists
                    </a>
                    <a href="/election/navigation" 
                       class="<%= path === '/election/navigation' || path.startsWith('/election/navigation') ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Navigation
                    </a>
                    <a href="/election/interactions" 
                       class="<%= path === '/election/interactions' || path.startsWith('/election/interactions') ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Interactions
                    </a>
                    <a href="/election/scrutineering" 
                       class="<%= path === '/election/scrutineering' || path.startsWith('/election/scrutineering') ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        Vote Tracking
                    </a>
                    <% } %>
                    <% if (user) { %>
                    <a href="/requests" 
                       class="<%= path === '/requests' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>
                              flex items-center justify-between pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium">
                        <span>Requests</span>
                        <span class="nav-requests-badge ml-2 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;"><span class="nav-requests-count">0</span></span>
                    </a>
                    <% } %>
                    <!-- Admin Menu - Inline Dropdown -->
                    <% if (user && (user.userType === 'app_owner' || (user.userType === 'account_holder' && user.isAdmin))) { %>
                    <div class="relative">
                        <button onclick="toggleMobileAdmin()" 
                                type="button"
                                id="mobileAdminLink"
                                aria-expanded="false"
                                aria-controls="mobileAdminDropdown"
                                aria-label="Admin menu"
                                class="w-full flex items-center pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                                       <%= path.startsWith('/admin') || path === '/management' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                            Admin
                            <svg id="mobileAdminArrow" 
                                 class="ml-auto w-4 h-4 transition-transform duration-200" 
                                 fill="none" 
                                 stroke="currentColor" 
                                 viewBox="0 0 24 24"
                                 aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        
                        <!-- Mobile Admin Dropdown Content -->
                        <div id="mobileAdminDropdown" 
                             class="hidden pl-4" 
                             role="menu" 
                             aria-labelledby="mobileAdminLink">
                            <div class="space-y-1">
                                <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider" role="presentation">
                                    Admin
                                </h3>
                                <a href="/management" 
                                   role="menuitem"
                                   class="block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                                          <%= path === '/management' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                    User Management
                                </a>
                                <a href="/admin/help-tickets" 
                                   role="menuitem"
                                   class="block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                                          <%= path === '/admin/help-tickets' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                    <div class="flex items-center justify-between">
                                        <span>Help Requests</span>
                                        <span id="helpTicketsCountMobile" class="ml-2 inline-flex items-center justify-center min-w-5 px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white hidden" style="display: none;">
                                            <span id="helpTicketsCountNumberMobile">0</span>
                                        </span>
                                    </div>
                                </a>
                                <a href="/admin/audit-logs" 
                                   role="menuitem"
                                   class="block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                                          <%= path === '/admin/audit-logs' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                    Audit Logs
                                </a>
                                <a href="/admin/sender-settings" 
                                   role="menuitem"
                                   class="block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                                          <%= path === '/admin/sender-settings' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                    Sender Settings (Email)
                                </a>
                                <a href="/admin/phone-numbers" 
                                   role="menuitem"
                                   class="block pl-3 pr-4 py-2 border-l-4 text-sm sm:text-base font-medium
                                          <%= path === '/admin/phone-numbers' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500' %>">
                                    Phone Numbers
                                </a>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
    </nav>

    <!-- Subscription Required Message (shown for non-subscribers) -->
    <div id="subscription-required-message" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6" style="display: none;">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.725-1.36 3.49 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <strong>Subscription Required:</strong> Please complete your subscription to access all features. 
                    <a href="/subscription" class="font-medium underline text-yellow-700 hover:text-yellow-600">
                        Subscribe now
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
<% } %>

<script src="/js/nav-help-tickets.js"></script> 