<div class="min-h-screen bg-gray-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" id="app">
    <%- include('partials/nav') %>
    
    <div class="py-4 sm:py-6">
        <div v-if="user" class="bg-white shadow-sm sm:shadow rounded-lg p-4 sm:p-6">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6">User Profile</h2>
            
            <!-- User Information -->
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <div class="mt-1 text-gray-900">{{ user.email }}</div>
                </div>

                <div v-if="user.username">
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <div class="mt-1 text-gray-900">{{ user.username }}</div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Account Created</label>
                    <div class="mt-1 text-gray-900">{{ new Date(user.createdAt).toLocaleDateString() }}</div>
                </div>

                <div v-if="user.lastLoginAt">
                    <label class="block text-sm font-medium text-gray-700">Last Login</label>
                    <div class="mt-1 text-gray-900">{{ new Date(user.lastLoginAt).toLocaleDateString() }}</div>
                </div>

                <!-- Account Status -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700">Account Status</label>
                        <div class="mt-1 flex items-center">
                            <span :class="{
                                'px-2 py-1 text-xs rounded-full': true,
                                'bg-green-100 text-green-800': user.isVerified,
                                'bg-yellow-100 text-yellow-800': !user.isVerified
                            }">
                                {{ user.isVerified ? 'Verified' : 'Unverified' }}
                            </span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700">Two-Factor Authentication</label>
                        <div class="mt-1 flex items-center">
                            <span :class="{
                                'px-2 py-1 text-xs rounded-full': true,
                                'bg-green-100 text-green-800': user.is2FAEnabled,
                                'bg-gray-100 text-gray-800': !user.is2FAEnabled
                            }">
                                {{ user.is2FAEnabled ? 'Enabled' : 'Disabled' }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Token Balance -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-blue-800">SMS Tokens</label>
                        <div class="mt-1 text-2xl font-bold text-blue-900">{{ user.smsTokens || 0 }}</div>
                        <p class="text-xs text-blue-600 mt-1">Available credits for SMS messages</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-green-800">Email Tokens</label>
                        <div class="mt-1 text-2xl font-bold text-green-900">{{ user.emailTokens || 0 }}</div>
                        <p class="text-xs text-green-600 mt-1">Available credits for email messages</p>
                    </div>
                </div>

                <!-- Subscription Status -->
                <div v-if="user.phoneNumbers && user.phoneNumbers.length > 0" class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">Active Subscriptions</label>
                    <div class="mt-2 space-y-2">
                        <div v-for="number in user.phoneNumbers" :key="number.id" class="flex justify-between items-center">
                            <div>
                                <span class="font-medium">{{ number.number }}</span>
                                <span class="text-sm text-gray-500 ml-2">${{ number.monthlyPrice || 4 }} CAD/month</span>
                            </div>
                            <span :class="{
                                'px-2 py-1 text-xs rounded-full': true,
                                'bg-green-100 text-green-800': number.subscriptionStatus === 'active' || !number.subscriptionStatus,
                                'bg-yellow-100 text-yellow-800': number.subscriptionStatus === 'past_due',
                                'bg-red-100 text-red-800': number.subscriptionStatus === 'canceled',
                                'bg-orange-100 text-orange-800': number.subscriptionStatus === 'canceling'
                            }">
                                {{ number.subscriptionStatus || 'active' }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Profile Information Form -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4">Profile Information</h3>
                    <form @submit.prevent="saveProfile" class="space-y-6">
                        
                        <!-- Username Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" 
                                   v-model="username" 
                                   placeholder="Enter a username (optional)"
                                   class="mt-1 block w-full border rounded-md px-3 py-2">
                            <p class="mt-1 text-sm text-gray-500">Username is optional but helps with account identification</p>
                        </div>

                        <!-- Personal Information -->
                        <div class="space-y-4">
                            <h4 class="text-md font-medium text-gray-700">Personal Information</h4>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">First Name</label>
                                    <input type="text" 
                                           v-model="firstName" 
                                           placeholder="Enter your first name"
                                           class="mt-1 block w-full border rounded-md px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Last Name</label>
                                    <input type="text" 
                                           v-model="lastName" 
                                           placeholder="Enter your last name"
                                           class="mt-1 block w-full border rounded-md px-3 py-2">
                                </div>
                            </div>
                            
                            <!-- Email Address -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" 
                                       v-model="email" 
                                       placeholder="your.email@example.com"
                                       class="mt-1 block w-full border rounded-md px-3 py-2">
                                <p class="mt-1 text-sm text-gray-500">Used for account login and notifications</p>
                            </div>
                            
                            <!-- Phone Number (for all users) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="tel" 
                                       v-model="personalPhone" 
                                       placeholder="(123) 456-7890"
                                       @input="formatPersonalPhoneNumber"
                                       class="mt-1 block w-full border rounded-md px-3 py-2">
                                <p class="mt-1 text-sm text-gray-500">Used for 2FA SMS verification and contact purposes</p>
                            </div>
                            
                            <p class="text-sm text-gray-500">Your personal information will appear on invoices and receipts</p>
                        </div>

                        <!-- Company Information (only for account holders) -->
                        <div v-if="isAccountHolder" class="space-y-4">
                            <h4 class="text-md font-medium text-gray-700">Company Information</h4>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Company Name *</label>
                                <input type="text" 
                                       v-model="company.name" 
                                       required
                                       class="mt-1 block w-full border rounded-md px-3 py-2">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="tel" 
                                       v-model="company.phone" 
                                       placeholder="(123) 456-7890"
                                       class="mt-1 block w-full border rounded-md px-3 py-2">
                            </div>

                            <!-- Address Fields -->
                            <div class="space-y-4">
                                <label class="block text-sm font-medium text-gray-700">Address</label>
                                
                                <div>
                                    <input v-model="company.address.street" 
                                           type="text" 
                                           placeholder="Street Address"
                                           class="mt-1 block w-full border rounded-md px-3 py-2">
                                </div>

                                <div>
                                    <input v-model="company.address.unit" 
                                           type="text" 
                                           placeholder="Apartment, suite, unit, etc. (optional)"
                                           class="mt-1 block w-full border rounded-md px-3 py-2">
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <input v-model="company.address.city" 
                                               type="text" 
                                               placeholder="City"
                                               class="mt-1 block w-full border rounded-md px-3 py-2">
                                    </div>
                                    <div>
                                        <input v-model="company.address.province" 
                                               type="text" 
                                               placeholder="Province"
                                               class="mt-1 block w-full border rounded-md px-3 py-2">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <input v-model="company.address.postalCode" 
                                               type="text" 
                                               placeholder="Postal Code"
                                               class="mt-1 block w-full border rounded-md px-3 py-2">
                                    </div>
                                    <div>
                                        <input v-model="company.address.country" 
                                               type="text" 
                                               placeholder="Country"
                                               class="mt-1 block w-full border rounded-md px-3 py-2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="flex flex-col sm:flex-row sm:justify-end pt-4 border-t">
                            <button type="submit" 
                                    :disabled="isSaving"
                                    class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 disabled:opacity-50 font-medium transition-colors duration-200">
                                {{ isSaving ? 'Saving...' : 'Save Profile Information' }}
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Change Password Form -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4">Change Password</h3>
                    <form @submit.prevent="changePassword" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Current Password</label>
                            <div class="relative !important">
                                <input :type="showCurrentPassword ? 'text' : 'password'"
                                       v-model="passwords.current"
                                       placeholder="••••••••"
                                       required
                                       class="mt-1 block w-full border rounded-md px-3 py-2 pr-12 !important">
                                <button type="button"
                                        @click="showCurrentPassword = !showCurrentPassword"
                                        class="absolute inset-y-0 right-0 flex items-center justify-center w-10 h-full focus:outline-none !important"
                                        style="position: absolute !important; top: 0 !important; right: 0 !important; height: 100% !important; width: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important;"
                                        tabindex="-1">
                                    <svg v-if="showCurrentPassword" class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                                    </svg>
                                    <svg v-else class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">New Password</label>
                            <div class="relative !important">
                                <input :type="showNewPassword ? 'text' : 'password'"
                                       v-model="passwords.new"
                                       placeholder="••••••••"
                                       required
                                       @input="validateNewPassword"
                                       class="mt-1 block w-full border rounded-md px-3 py-2 pr-12 !important">
                                <button type="button"
                                        @click="showNewPassword = !showNewPassword"
                                        class="absolute inset-y-0 right-0 flex items-center justify-center w-10 h-full focus:outline-none !important"
                                        style="position: absolute !important; top: 0 !important; right: 0 !important; height: 100% !important; width: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important;"
                                        tabindex="-1">
                                    <svg v-if="showNewPassword" class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                                    </svg>
                                    <svg v-else class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Password Requirements -->
                            <div v-if="passwords.new" class="mt-2 p-3 bg-gray-50 rounded-md border border-gray-200">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Password Requirements:</h4>
                                <ul class="text-xs space-y-1">
                                    <li :class="passwordRequirements.length ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.length" class="inline-block w-4">✓</span>
                                        <span v-else class="inline-block w-4">○</span>
                                        At least 8 characters
                                    </li>
                                    <li :class="passwordRequirements.uppercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.uppercase" class="inline-block w-4">✓</span>
                                        <span v-else class="inline-block w-4">○</span>
                                        At least 1 uppercase letter
                                    </li>
                                    <li :class="passwordRequirements.lowercase ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.lowercase" class="inline-block w-4">✓</span>
                                        <span v-else class="inline-block w-4">○</span>
                                        At least 1 lowercase letter
                                    </li>
                                    <li :class="passwordRequirements.number ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.number" class="inline-block w-4">✓</span>
                                        <span v-else class="inline-block w-4">○</span>
                                        At least 1 number
                                    </li>
                                    <li :class="passwordRequirements.special ? 'text-green-600 font-medium' : 'text-gray-500'">
                                        <span v-if="passwordRequirements.special" class="inline-block w-4">✓</span>
                                        <span v-else class="inline-block w-4">○</span>
                                        At least 1 special character (!@#$%^&*)
                                    </li>
                                </ul>
                                <div v-if="passwordStrength" class="mt-2 pt-2 border-t border-gray-200">
                                    <span class="text-xs font-medium text-gray-700">Strength: </span>
                                    <span :class="{
                                        'text-red-600 font-medium': passwordStrength === 'weak',
                                        'text-yellow-600 font-medium': passwordStrength === 'medium',
                                        'text-green-600 font-medium': passwordStrength === 'strong'
                                    }" class="text-xs">{{ passwordStrength }}</span>
                                </div>
                                
                                <!-- Password Generator Suggestion -->
                                <div v-if="!isPasswordValid && passwords.new" class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs">
                                    <p class="text-yellow-800 mb-1 font-medium">Need help?</p>
                                    <p class="text-yellow-700 mb-1">Try a password like: <code class="bg-yellow-100 px-1 py-0.5 rounded font-mono text-xs">MySecure!2024</code></p>
                                    <p class="text-yellow-600 text-xs">This example meets all requirements: uppercase, lowercase, number, and special character.</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <div class="relative !important">
                                <input :type="showConfirmPassword ? 'text' : 'password'"
                                       v-model="passwords.confirm"
                                       placeholder="••••••••"
                                       required
                                       class="mt-1 block w-full border rounded-md px-3 py-2 pr-12 !important">
                                <button type="button"
                                        @click="showConfirmPassword = !showConfirmPassword"
                                        class="absolute inset-y-0 right-0 flex items-center justify-center w-10 h-full focus:outline-none !important"
                                        style="position: absolute !important; top: 0 !important; right: 0 !important; height: 100% !important; width: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important;"
                                        tabindex="-1">
                                    <svg v-if="showConfirmPassword" class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                                    </svg>
                                    <svg v-else class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                            <p v-if="!passwordsMatch" class="mt-1 text-sm text-red-600">
                                Passwords do not match
                            </p>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" 
                                    :disabled="!passwordsMatch || isLoading"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 disabled:opacity-50">
                                {{ isLoading ? 'Updating...' : 'Update Password' }}
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Two-Factor Authentication Management -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4">Two-Factor Authentication (2FA)</h3>
                    
                    <!-- Current 2FA Status -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">{{ user.is2FAEnabled ? '2FA is Enabled' : '2FA is Disabled' }}</h4>
                                <p class="text-sm text-gray-600 mt-1">
                                    {{ user.is2FAEnabled ? 
                                        `Your account is protected with ${user.twoFactorMethod === 'sms' ? 'SMS' : 'email'} verification.` : 
                                        'Add an extra layer of security to your account with SMS or email verification.' 
                                    }}
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span :class="{
                                    'px-3 py-1 text-sm rounded-full font-medium': true,
                                    'bg-green-100 text-green-800': user.is2FAEnabled,
                                    'bg-gray-100 text-gray-800': !user.is2FAEnabled
                                }">
                                    {{ user.is2FAEnabled ? 'Active' : 'Inactive' }}
                                </span>
                                <span v-if="user.is2FAEnabled" class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">
                                    {{ user.twoFactorMethod === 'sms' ? 'SMS' : 'Email' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Info Requirements -->
                    <div v-if="!user.is2FAEnabled && !show2FASetup" class="mb-4">
                        <div v-if="!hasPhoneNumber && !user.email" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <svg class="h-5 w-5 text-yellow-400 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <h4 class="font-medium text-yellow-800">Contact Information Required</h4>
                                    <p class="text-yellow-700 text-sm mt-1">
                                        To enable 2FA, you need either a phone number or email address. Please add your contact information above first.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enable 2FA Options -->
                        <div v-else class="space-y-4">
                            <p class="text-sm text-gray-600">
                                Choose how you'd like to receive verification codes:
                            </p>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                <!-- SMS Option -->
                                <div v-if="hasPhoneNumber" 
                                     class="border border-gray-200 rounded-lg p-4 hover:border-indigo-300 transition-colors">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <svg class="h-6 w-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                            </svg>
                                            <h4 class="font-medium">SMS Verification</h4>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">
                                        Get verification codes sent to {{ maskedPhoneNumber }}
                                    </p>
                                    <p class="text-xs text-green-600 mb-3">
                                        ✓ No phone number purchase required - uses system messaging
                                    </p>
                                    <button @click="start2FASetup('sms')" 
                                            :disabled="isLoading2FA"
                                            class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50 font-medium">
                                        {{ isLoading2FA && selectedMethod === 'sms' ? 'Setting up...' : 'Enable SMS 2FA' }}
                                    </button>
                                </div>
                                
                                <!-- Email Option -->
                                <div v-if="user.email" class="border border-gray-200 rounded-lg p-4 hover:border-indigo-300 transition-colors">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <svg class="h-6 w-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                            </svg>
                                            <h4 class="font-medium">Email Verification</h4>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">
                                        Get verification codes sent to {{ maskedEmail }}
                                    </p>
                                    <button @click="start2FASetup('email')" 
                                            :disabled="isLoading2FA"
                                            style="background-color: #2563eb !important; color: white !important; min-height: 44px !important;"
                                            class="w-full inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 shadow-sm">
                                        <svg v-if="isLoading2FA && selectedMethod === 'email'" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        {{ isLoading2FA && selectedMethod === 'email' ? 'Setting up...' : 'Enable Email 2FA' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2FA Setup Verification -->
                    <div v-if="show2FASetup && !user.is2FAEnabled" class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-medium text-green-900 mb-2">Verification Code Sent</h4>
                            <p class="text-green-800 text-sm mb-3">
                                {{ setupMessage }}
                            </p>
                            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-2">
                                <input type="text" 
                                       placeholder="123456"
                                       maxlength="6"
                                       ref="codeInput"
                                       @input="handle2FAInput"
                                       @keypress="handleKeyPress"
                                       autocomplete="off"
                                       pattern="[0-9]*"
                                       inputmode="numeric"
                                       :value="verificationCode2FA"
                                       class="flex-1 border rounded-md px-3 py-3 text-center font-mono text-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <button @click="verify2FA" 
                                        :disabled="!verificationCode2FA || verificationCode2FA.length !== 6 || isLoading2FA"
                                        class="w-full sm:w-auto bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 disabled:opacity-50 transition-colors font-medium">
                                    {{ isLoading2FA ? 'Verifying...' : 'Verify & Enable' }}
                                </button>
                            </div>
                            <p class="text-green-700 text-xs mt-2">
                                Code expires in 10 minutes. Didn't receive it? 
                                <button @click="start2FASetup(selectedMethod)" class="underline hover:no-underline">
                                    Resend code
                                </button>
                            </p>

                        </div>

                        <button @click="cancel2FASetup" 
                                class="text-gray-600 hover:text-gray-800 text-sm">
                            Cancel Setup
                        </button>
                    </div>

                    <!-- Disable 2FA Section -->
                    <div v-if="user.is2FAEnabled" class="space-y-4">
                        <!-- Debug info (remove in production) -->
                        <div class="text-xs p-2 bg-blue-100 rounded border mb-2">
                            <strong>Debug:</strong> 2FA is enabled: {{ user.is2FAEnabled }} | Method: {{ user.twoFactorMethod }} | Loading: {{ isLoading2FA }}
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-medium text-red-900 mb-2">Disable Two-Factor Authentication</h4>
                            <p class="text-red-800 text-sm mb-3">
                                Warning: Disabling 2FA will reduce your account security. Are you sure you want to continue?
                            </p>
                            <button @click="disable2FA" 
                                    :disabled="isLoading2FA"
                                    style="background-color: #dc2626 !important; color: white !important; min-height: 40px !important; min-width: 120px !important;"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 shadow-sm">
                                <svg v-if="isLoading2FA" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                {{ isLoading2FA ? 'Disabling...' : 'Disable 2FA' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add this section after the password change form (Account Holders Only) -->
                <div v-if="isAccountHolder" class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4">Active Subscriptions</h3>
                    
                    <!-- Phone Numbers -->
                    <div v-if="user.phoneNumbers && user.phoneNumbers.length > 0">
                        <div class="space-y-4">
                            <div v-for="number in user.phoneNumbers" :key="number.id" 
                                 class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium">Phone Number: {{ number.number }}</p>
                                        <div class="mt-1 text-sm text-gray-600 space-y-1">
                                            <p>Monthly Price: ${{ number.monthlyPrice.toFixed(2) }} CAD</p>
                                            <p>Purchased: {{ new Date(number.purchasedAt).toLocaleDateString() }}</p>
                                            <p v-if="number.currentPeriodEnd">
                                                Next Billing Date: {{ new Date(number.currentPeriodEnd).toLocaleDateString() }}
                                            </p>
                                            <p v-if="number.willCancelAt" class="text-red-600">
                                                Will cancel on: {{ new Date(number.willCancelAt).toLocaleDateString() }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end space-y-2">
                                        <div class="flex items-center">
                                            <span :class="{
                                                'px-2 py-1 text-xs rounded-full': true,
                                                'bg-green-100 text-green-800': number.subscriptionStatus === 'active',
                                                'bg-yellow-100 text-yellow-800': number.subscriptionStatus === 'past_due',
                                                'bg-red-100 text-red-800': number.subscriptionStatus === 'canceled',
                                                'bg-orange-100 text-orange-800': number.subscriptionStatus === 'canceling'
                                            }">
                                                {{ number.subscriptionStatus || 'active' }}
                                            </span>
                                            <span v-if="number.isDefault" 
                                                  class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                                Default
                                            </span>
                                        </div>
                                        <button v-if="number.subscriptionStatus === 'active' || !number.subscriptionStatus"
                                                @click="cancelSubscription(number)"
                                                :disabled="isCanceling"
                                                class="text-sm text-red-600 hover:text-red-800">
                                            {{ isCanceling ? 'Canceling...' : 'Cancel Subscription' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No subscriptions message -->
                    <div v-else class="text-center py-4 text-gray-500">
                        No active subscriptions
                    </div>
                    
                    <!-- Total Monthly Cost -->
                    <div v-if="totalMonthlyCost > 0" class="mt-4 pt-4 border-t">
                        <div class="flex justify-between items-center font-medium">
                            <span>Total Monthly Cost:</span>
                            <span>${{ totalMonthlyCost.toFixed(2) }} CAD</span>
                        </div>
                    </div>
                </div>

                <!-- Account Statistics -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4">Account Statistics</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-900">{{ user.contacts ? user.contacts.length : 0 }}</div>
                            <div class="text-sm text-blue-600">Total Contacts</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-900">{{ user.messageTemplates ? user.messageTemplates.length : 0 }}</div>
                            <div class="text-sm text-green-600">Message Templates</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-900">{{ 
                                (user.smsMessages?.sent?.length || 0) + 
                                (user.emailMessages?.sent?.length || 0) 
                            }}</div>
                            <div class="text-sm text-purple-600">Messages Sent</div>
                        </div>
                    </div>

                </div>

                <!-- Team Management Section (Account Holders Only) -->
                <div v-if="isAccountHolder" class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4 text-blue-900">Team Management</h3>
                    
                    <!-- Invite User Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <h4 class="font-medium text-blue-900 mb-4">Invite Team Member</h4>
                        <div class="flex gap-4" style="display: flex; gap: 16px; align-items: center;">
                            <input 
                                type="email" 
                                v-model="inviteEmail" 
                                placeholder="Enter email address" 
                                class="form-control"
                                style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; margin-right: 16px;"
                                :disabled="isInviting"
                            >
                            <button 
                                @click="inviteUser" 
                                :disabled="!inviteEmail || isInviting"
                                class="btn btn-primary"
                                style="background-color: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; min-width: 120px;"
                                :style="{ opacity: (!inviteEmail || isInviting) ? '0.5' : '1', cursor: (!inviteEmail || isInviting) ? 'not-allowed' : 'pointer' }"
                            >
                                <span v-if="isInviting">Sending...</span>
                                <span v-else>Send Invite</span>
                            </button>
                        </div>
                        <div v-if="inviteMessage" class="mt-3 text-sm" :class="inviteMessage.type === 'success' ? 'text-green-600' : 'text-red-600'">
                            {{ inviteMessage.text }}
                        </div>
                    </div>

                    <!-- Team Members List -->
                    <div class="bg-white border border-gray-200 rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900">Team Members</h4>
                        </div>
                        
                        <div v-if="loadingTeam" class="p-6 text-center">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                            <div class="mt-2 text-sm text-gray-600">Loading team...</div>
                        </div>

                        <div v-else-if="teamMembers.length === 0 && pendingInvitations.length === 0" class="p-6 text-center text-gray-500">
                            <div class="text-sm">No team members yet. Invite someone to get started!</div>
                        </div>

                        <div v-else class="divide-y divide-gray-200">
                            <!-- Active Team Members -->
                            <div v-for="member in teamMembers" :key="member.id" class="px-6 py-4 flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                                            <span class="text-sm font-medium text-white">
                                                {{ (member.personalInfo?.firstName?.[0] || member.email?.[0] || 'U').toUpperCase() }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ member.personalInfo?.firstName && member.personalInfo?.lastName 
                                                ? `${member.personalInfo.firstName} ${member.personalInfo.lastName}` 
                                                : member.email }}
                                        </div>
                                        <div class="text-sm text-gray-500">{{ member.email }}</div>
                                        <div class="flex items-center mt-1">
                                            <span :class="{
                                                'px-2 py-1 text-xs rounded-full': true,
                                                'bg-purple-100 text-purple-800': member.userType === 'account_holder',
                                                'bg-blue-100 text-blue-800': member.userType === 'team_member',
                                                'bg-red-100 text-red-800': member.userType === 'app_owner'
                                            }">
                                                {{ member.userType === 'account_holder' ? 'Account Holder' : 
                                                   member.userType === 'team_member' ? 'Team Member' : 
                                                   member.userType === 'app_owner' ? 'App Owner' : 'User' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="member.userType !== 'account_holder' && member.userType !== 'app_owner' && member.id !== user.id" class="flex items-center">
                                    <button 
                                        @click="removeTeamMember(member.id, member.email)"
                                        class="text-red-600 hover:text-red-800 text-sm"
                                    >
                                        Remove
                                    </button>
                                </div>
                            </div>

                            <!-- Pending Invitations -->
                            <div v-for="invitation in pendingInvitations" :key="invitation.id" class="px-6 py-4 flex items-center justify-between bg-gray-50">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                            <span class="text-sm font-medium text-gray-600">
                                                {{ invitation.email[0].toUpperCase() }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">{{ invitation.email }}</div>
                                        <div class="text-sm text-gray-500">
                                            Invited {{ new Date(invitation.createdAt).toLocaleDateString() }}
                                        </div>
                                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                            Pending
                                        </span>
                                        <div class="mt-1 text-xs text-gray-400">
                                            Expires {{ new Date(invitation.expiresAt).toLocaleDateString() }}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button 
                                        @click="resendInvitation(invitation.id, invitation.email)"
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                        style="padding: 4px 8px; border: 1px solid #2563eb; border-radius: 4px; background: white;"
                                        :disabled="isProcessingInvitation"
                                    >
                                        <span v-if="isProcessingInvitation && currentInvitationId === invitation.id">Sending...</span>
                                        <span v-else>Resend</span>
                                    </button>
                                    <button 
                                        @click="cancelInvitation(invitation.id, invitation.email)"
                                        class="text-red-600 hover:text-red-800 text-sm font-medium"
                                        style="padding: 4px 8px; border: 1px solid #dc2626; border-radius: 4px; background: white;"
                                        :disabled="isProcessingInvitation"
                                    >
                                        <span v-if="isProcessingInvitation && currentInvitationId === invitation.id">Canceling...</span>
                                        <span v-else>Cancel</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Deactivation Section (Account Holders Only) -->
                <div v-if="isAccountHolder" class="border-t pt-6 mt-6">
                    <h3 class="text-lg font-medium mb-4 text-red-900">Account Deactivation</h3>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <div class="flex items-start">
                            <svg class="h-6 w-6 text-red-400 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <div class="flex-1">
                                <h4 class="font-medium text-red-900 mb-2">Permanently Delete Account</h4>
                                <div class="text-red-800 text-sm space-y-2 mb-4">
                                    <p><strong>Warning:</strong> This action cannot be undone. Deactivating your account will permanently delete:</p>
                                    <ul class="ml-4 list-disc space-y-1">
                                        <li>All your contacts and contact lists</li>
                                        <li>All message templates and email campaigns</li>
                                        <li>Message history and analytics data</li>
                                        <li>Token balance and purchase history</li>
                                        <li>Phone number subscriptions (will be canceled)</li>
                                        <li>All account settings and preferences</li>
                                    </ul>
                                    <p class="mt-3 font-medium">Your account and all associated data will be permanently removed from our servers.</p>
                                </div>
                                
                                <div v-if="!showDeactivationConfirm" class="flex flex-col sm:flex-row gap-3">
                                    <button @click="showDeactivationConfirm = true"
                                            style="background-color: #dc2626 !important; color: white !important; padding: 12px 24px !important; border-radius: 6px !important; font-weight: 500 !important; border: none !important; cursor: pointer !important; transition: background-color 0.2s !important; display: inline-block !important; text-align: center !important;"
                                            onmouseover="this.style.backgroundColor='#b91c1c'"
                                            onmouseout="this.style.backgroundColor='#dc2626'"
                                            class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition-colors font-medium">
                                        Delete My Account
                                    </button>
                                </div>
                                
                                <!-- Confirmation Steps -->
                                <div v-if="showDeactivationConfirm" class="space-y-4">
                                    <div class="bg-red-100 border border-red-300 rounded-lg p-4">
                                        <h5 class="font-medium text-red-900 mb-3">Confirm Account Deletion</h5>
                                        
                                        <div class="space-y-3">
                                            <div>
                                                <label class="flex items-start space-x-2">
                                                    <input type="checkbox" v-model="deactivationConfirm.dataLoss" class="mt-1">
                                                    <span class="text-sm text-red-800">
                                                        I understand that all my data will be permanently deleted and cannot be recovered.
                                                    </span>
                                                </label>
                                            </div>
                                            
                                            <div>
                                                <label class="flex items-start space-x-2">
                                                    <input type="checkbox" v-model="deactivationConfirm.subscriptions" class="mt-1">
                                                    <span class="text-sm text-red-800">
                                                        I understand that all active subscriptions will be canceled immediately.
                                                    </span>
                                                </label>
                                            </div>
                                            
                                            <div>
                                                <label class="flex items-start space-x-2">
                                                    <input type="checkbox" v-model="deactivationConfirm.finalConfirm" class="mt-1">
                                                    <span class="text-sm text-red-800">
                                                        I want to permanently delete my account and all associated data.
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <label class="block text-sm font-medium text-red-900 mb-2">
                                                Type "DELETE" to confirm:
                                            </label>
                                            <input type="text" 
                                                   v-model="deactivationConfirm.deleteText"
                                                   placeholder="Type DELETE here"
                                                   class="block w-full sm:w-48 border border-red-300 rounded-md px-3 py-2 text-sm">
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <button @click="deactivateAccount"
                                                :disabled="!canDeactivate || isDeletingAccount"
                                                style="background-color: #dc2626 !important; color: white !important; padding: 12px 24px !important; border-radius: 6px !important; font-weight: 500 !important; border: none !important; cursor: pointer !important; transition: background-color 0.2s !important; display: inline-block !important; text-align: center !important; margin-right: 12px !important;"
                                                :style="{ opacity: (!canDeactivate || isDeletingAccount) ? '0.5' : '1', cursor: (!canDeactivate || isDeletingAccount) ? 'not-allowed' : 'pointer' }"
                                                onmouseover="if (!this.disabled) this.style.backgroundColor='#b91c1c'"
                                                onmouseout="if (!this.disabled) this.style.backgroundColor='#dc2626'"
                                                class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">
                                            {{ isDeletingAccount ? 'Deleting Account...' : 'Permanently Delete Account' }}
                                        </button>
                                        <button @click="cancelDeactivation"
                                                :disabled="isDeletingAccount"
                                                style="background-color: #d1d5db !important; color: #374151 !important; padding: 12px 24px !important; border-radius: 6px !important; font-weight: 500 !important; border: none !important; cursor: pointer !important; transition: background-color 0.2s !important; display: inline-block !important; text-align: center !important;"
                                                :style="{ opacity: isDeletingAccount ? '0.5' : '1', cursor: isDeletingAccount ? 'not-allowed' : 'pointer' }"
                                                onmouseover="if (!this.disabled) this.style.backgroundColor='#9ca3af'"
                                                onmouseout="if (!this.disabled) this.style.backgroundColor='#d1d5db'"
                                                class="bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400 disabled:opacity-50 transition-colors font-medium">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Loading state -->
        <div v-else class="text-center py-12">
            <svg class="animate-spin h-8 w-8 mx-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-600">Loading user data...</p>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue

createApp({
    data() {
        return {
            user: null,
            passwords: {
                current: '',
                new: '',
                confirm: ''
            },
            username: '',
            firstName: '',
            lastName: '',
            email: '',
            personalPhone: '',
            company: {
                name: '',
                phone: '',
                address: {
                    street: '',
                    unit: '',
                    city: '',
                    province: '',
                    postalCode: '',
                    country: ''
                }
            },
            isLoading: false,
            isCanceling: false,
            isSaving: false,
            showCurrentPassword: false,
            showNewPassword: false,
            showConfirmPassword: false,
            passwordRequirements: {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false,
                special: false
            },
            passwordStrength: '',
            // 2FA related data
            show2FASetup: false,
            isLoading2FA: false,
            verificationCode2FA: '',
            selectedMethod: '',
            setupMessage: '',
            // Account deactivation properties
            showDeactivationConfirm: false,
            isDeletingAccount: false,
            deactivationConfirm: {
                dataLoss: false,
                subscriptions: false,
                finalConfirm: false,
                deleteText: ''
            },
            // Team management data
            inviteEmail: '',
            isInviting: false,
            inviteMessage: null,
            teamMembers: [],
            pendingInvitations: [],
            loadingTeam: false,
            isProcessingInvitation: false,
            currentInvitationId: null
        }
    },
    computed: {
        isTeamMember() {
            // Team member: has accountId different from their own id, or userType is 'team_member'
            return this.user && (this.user.userType === 'team_member' || (this.user.accountId && this.user.accountId !== this.user.id));
        },
        isAccountHolder() {
            // Account holder: userType is account_holder or app_owner, and accountId matches id (or no accountId for legacy users)
            return this.user && (this.user.userType === 'account_holder' || this.user.userType === 'app_owner') && (!this.user.accountId || this.user.accountId === this.user.id);
        },
        passwordsMatch() {
            return this.passwords.new === this.passwords.confirm;
        },
        totalMonthlyCost() {
            if (!this.user?.phoneNumbers) return 0;
            return this.user.phoneNumbers.reduce((total, number) => {
                if (number.subscriptionStatus !== 'canceled') {
                    return total + (number.monthlyPrice || 0);
                }
                return total;
            }, 0);
        },
        isPasswordValid() {
            return this.passwordRequirements.length && 
                   this.passwordRequirements.uppercase && 
                   this.passwordRequirements.lowercase && 
                   this.passwordRequirements.number && 
                   this.passwordRequirements.special;
        },
        hasPhoneNumber() {
            // For team members, check personalInfo.phone; for account holders, check company.phone
            const phone = this.user?.userType === 'team_member' 
                ? this.user?.personalInfo?.phone 
                : this.user?.company?.phone;
            return phone && phone.trim() !== '';
        },
        maskedPhoneNumber() {
            if (!this.hasPhoneNumber) return '';
            const phone = this.user?.userType === 'team_member' 
                ? this.user?.personalInfo?.phone 
                : this.user?.company?.phone;
            return phone.replace(/(\d{3})\d{3}(\d{4})/, '$1***$2');
        },
        maskedEmail() {
            if (!this.user?.email) return '';
            return this.user.email.replace(/(.{2}).*(@.*)/, '$1***$2');
        },
        canDeactivate() {
            return this.deactivationConfirm.dataLoss && 
                   this.deactivationConfirm.subscriptions && 
                   this.deactivationConfirm.finalConfirm && 
                   this.deactivationConfirm.deleteText === 'DELETE';
        }
    },
    methods: {
        validateNewPassword() {
            if (!this.passwords.new) {
                this.passwordRequirements = {
                    length: false,
                    uppercase: false,
                    lowercase: false,
                    number: false,
                    special: false
                };
                this.passwordStrength = '';
                return;
            }

            // Check password requirements
            this.passwordRequirements = {
                length: this.passwords.new.length >= 8,
                uppercase: /[A-Z]/.test(this.passwords.new),
                lowercase: /[a-z]/.test(this.passwords.new),
                number: /[0-9]/.test(this.passwords.new),
                special: /[!@#$%^&*]/.test(this.passwords.new)
            };

            // Calculate password strength
            const requirementsMet = Object.values(this.passwordRequirements).filter(Boolean).length;
            if (requirementsMet <= 2) {
                this.passwordStrength = 'weak';
            } else if (requirementsMet <= 4) {
                this.passwordStrength = 'medium';
            } else {
                this.passwordStrength = 'strong';
            }
        },

        formatPersonalPhoneNumber() {
            // Remove all non-numeric characters
            let phone = this.personalPhone.replace(/\D/g, '');
            
            // Limit to 10 digits
            if (phone.length > 10) {
                phone = phone.substring(0, 10);
            }
            
            // Format as (XXX) XXX-XXXX
            if (phone.length >= 6) {
                phone = `(${phone.substring(0, 3)}) ${phone.substring(3, 6)}-${phone.substring(6)}`;
            } else if (phone.length >= 3) {
                phone = `(${phone.substring(0, 3)}) ${phone.substring(3)}`;
            } else if (phone.length > 0) {
                phone = `(${phone}`;
            }
            
            this.personalPhone = phone;
        },

        async loadUserData() {
            try {
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    this.user = await response.json();
                    
                    // Initialize username from user
                    this.username = this.user.username || '';
                    
                    // Initialize personal information
                    this.firstName = this.user.firstName || '';
                    this.lastName = this.user.lastName || '';
                    this.email = this.user.email || '';
                    
                    // Load personal phone from personalInfo for all users
                    this.personalPhone = this.user.personalInfo?.phone || '';
                    
                    // Initialize company data from user
                    if (this.user.company) {
                        this.company = {
                            name: this.user.company.name || '',
                            phone: this.user.company.phone || '',
                            address: {
                                street: this.user.company.address?.street || '',
                                unit: this.user.company.address?.unit || '',
                                city: this.user.company.address?.city || '',
                                province: this.user.company.address?.province || '',
                                postalCode: this.user.company.address?.postalCode || '',
                                country: this.user.company.address?.country || ''
                            }
                        };
                    }
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
            }
        },
        
        async saveProfile() {
            this.isSaving = true;
            try {
                // Update username if changed
                if (this.username !== this.user.username) {
                    const usernameResponse = await fetch('/api/user/username', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            username: this.username
                        })
                    });
                    
                    if (!usernameResponse.ok) {
                        const error = await usernameResponse.json();
                        throw new Error(error.error);
                    }
                }

                // Update personal information (including email and phone for all users)
                const personalResponse = await fetch('/api/user/personal', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        firstName: this.firstName,
                        lastName: this.lastName,
                        email: this.email,
                        personalPhone: this.personalPhone
                    })
                });
                
                if (!personalResponse.ok) {
                    const error = await personalResponse.json();
                    throw new Error(error.error);
                }

                // Update company information (only for account holders)
                const companyResponse = await fetch('/api/user/company', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        company: this.company
                    })
                });
                
                if (!companyResponse.ok) {
                    const error = await companyResponse.json();
                    throw new Error(error.error);
                }

                await this.loadUserData(); // Reload user data
                alert('Profile information updated successfully');
            } catch (error) {
                alert(error.message || 'Failed to update profile information');
            } finally {
                this.isSaving = false;
            }
        },

        async changePassword() {
            if (!this.passwordsMatch) return;
            
            // Check if new password meets requirements
            if (!this.isPasswordValid) {
                alert('Please ensure your new password meets all requirements.');
                return;
            }
            
            this.isLoading = true;
            try {
                const response = await fetch('/api/user/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        currentPassword: this.passwords.current,
                        newPassword: this.passwords.new
                    })
                });
                
                if (response.ok) {
                    alert('Password updated successfully');
                    this.passwords = { current: '', new: '', confirm: '' };
                } else {
                    const error = await response.json();
                    throw new Error(error.error);
                }
            } catch (error) {
                alert(error.message || 'Failed to update password');
            } finally {
                this.isLoading = false;
            }
        },

        async cancelSubscription(number) {
            if (!confirm(`Are you sure you want to cancel the subscription for ${number.number}? The number will remain active until the end of the billing period.`)) {
                return;
            }

            this.isCanceling = true;
            try {
                const response = await fetch('/api/subscriptions/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        subscriptionId: number.subscriptionId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                const result = await response.json();
                await this.loadUserData(); // Reload user data to show updated status
                alert(result.message);
            } catch (error) {
                alert(error.message || 'Failed to cancel subscription');
            } finally {
                this.isCanceling = false;
            }
        },

        // 2FA Management Methods
        async start2FASetup(method) {
            this.selectedMethod = method;
            this.isLoading2FA = true;
            try {
                const response = await fetch('/api/2fa/enable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ method })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Handle specific errors for missing contact info
                    if (data.requiresPhone) {
                        alert('Please add a phone number to your profile first to enable SMS 2FA.');
                        return;
                    }
                    if (data.requiresEmail) {
                        alert('Please add an email address to your profile first to enable email 2FA.');
                        return;
                    }
                    throw new Error(data.error);
                }
                
                this.show2FASetup = true;
                this.setupMessage = data.message;
                this.verificationCode2FA = '';
                
                // Focus the input field after the form appears
                this.$nextTick(() => {
                    if (this.$refs.codeInput) {
                        this.$refs.codeInput.focus();
                    }
                });
            } catch (error) {
                // Handle specific error types
                if (error.message.includes('add a phone number to your profile') || data.requiresPhone) {
                    alert('Please add a phone number to your profile first to enable SMS 2FA.');
                } else {
                    alert(error.message || 'Failed to initialize 2FA setup');
                }
            } finally {
                this.isLoading2FA = false;
            }
        },

        async verify2FA() {
            this.isLoading2FA = true;
            try {
                const response = await fetch('/api/2fa/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        code: this.verificationCode2FA
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                // Success - 2FA is now enabled
                this.show2FASetup = false;
                this.verificationCode2FA = '';
                this.selectedMethod = '';
                this.setupMessage = '';
                
                await this.loadUserData(); // Reload to show updated 2FA status
                alert(data.message || 'Two-Factor Authentication has been successfully enabled!');
            } catch (error) {
                alert(error.message || 'Failed to verify 2FA code. Please try again.');
            } finally {
                this.isLoading2FA = false;
            }
        },

        async disable2FA() {
            if (!confirm('Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.')) {
                return;
            }

            this.isLoading2FA = true;
            try {
                const response = await fetch('/api/2fa/disable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                await this.loadUserData(); // Reload to show updated 2FA status
                alert(data.message || 'Two-Factor Authentication has been disabled.');
            } catch (error) {
                alert(error.message || 'Failed to disable 2FA');
            } finally {
                this.isLoading2FA = false;
            }
        },

        cancel2FASetup() {
            this.show2FASetup = false;
            this.verificationCode2FA = '';
            this.selectedMethod = '';
            this.setupMessage = '';
        },
        
        // Handle 2FA input to ensure only numbers
        handle2FAInput(event) {
            const value = event.target.value.replace(/[^0-9]/g, '');
            this.verificationCode2FA = value;
            
            // Force Vue to update
            this.$forceUpdate();
            
            // Auto-submit when 6 digits are entered
            if (value.length === 6) {
                this.$nextTick(() => {
                    this.verify2FA();
                });
            }
        },
        
        // Handle key press for Enter key
        handleKeyPress(event) {
            if (event.key === 'Enter' && this.verificationCode2FA.length === 6) {
                this.verify2FA();
            }
        },

        // Account Deactivation Methods
        async deactivateAccount() {
            if (!this.canDeactivate) {
                alert('Please complete all confirmation steps before proceeding.');
                return;
            }

            const finalWarning = `FINAL WARNING: This will permanently delete your account and all data.\n\nThis includes:\n- All contacts and message history\n- All templates and campaigns\n- Token balance and purchase history\n- All subscriptions will be canceled\n\nThis action CANNOT be undone.\n\nType "CONFIRM DELETE" to proceed:`;
            
            const finalConfirmation = prompt(finalWarning);
            if (finalConfirmation !== 'CONFIRM DELETE') {
                alert('Account deletion canceled. You must type "CONFIRM DELETE" exactly to proceed.');
                return;
            }

            this.isDeletingAccount = true;
            try {
                const response = await fetch('/api/account', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete account');
                }

                // Account successfully deleted
                alert('Your account has been permanently deleted. You will now be logged out.');
                
                // Clear local storage and redirect to login
                localStorage.removeItem('token');
                window.location.href = '/login?loop=1&message=Account+deleted+successfully';
            } catch (error) {
                alert(error.message || 'Failed to delete account. Please try again or contact support.');
            } finally {
                this.isDeletingAccount = false;
            }
        },

        cancelDeactivation() {
            this.showDeactivationConfirm = false;
            this.deactivationConfirm = {
                dataLoss: false,
                subscriptions: false,
                finalConfirm: false,
                deleteText: ''
            };
        },

        // Team Management Methods
        async loadTeamData() {
            if (this.user?.userType !== 'account_holder' && this.user?.userType !== 'app_owner') {
                return;
            }

            this.loadingTeam = true;
            try {
                const response = await fetch('/api/users/team', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load team data');
                }

                const data = await response.json();
                this.teamMembers = data.teamMembers || [];
                this.pendingInvitations = data.pendingInvitations || [];

            } catch (error) {
                console.error('Failed to load team data:', error);
            } finally {
                this.loadingTeam = false;
            }
        },

        async inviteUser() {
            if (!this.inviteEmail || this.isInviting) return;

            this.isInviting = true;
            this.inviteMessage = null;

            try {
                const response = await fetch('/api/users/invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        email: this.inviteEmail
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send invitation');
                }

                this.inviteMessage = {
                    type: 'success',
                    text: 'Invitation sent successfully!'
                };
                this.inviteEmail = '';
                
                // Refresh team data to show new pending invitation
                await this.loadTeamData();

            } catch (error) {
                this.inviteMessage = {
                    type: 'error',
                    text: error.message
                };
            } finally {
                this.isInviting = false;
            }
        },

        async removeTeamMember(userId, email) {
            if (!confirm(`Are you sure you want to remove ${email} from your team?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to remove team member');
                }

                alert('Team member removed successfully');
                
                // Refresh team data
                await this.loadTeamData();

            } catch (error) {
                alert(error.message);
            }
        },

        async resendInvitation(invitationId, email) {
            if (!confirm(`Resend invitation to ${email}?`)) {
                return;
            }

            this.isProcessingInvitation = true;
            this.currentInvitationId = invitationId;

            try {
                const response = await fetch(`/api/users/invitations/${invitationId}/resend`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to resend invitation');
                }

                alert('Invitation resent successfully!');
                
                // Refresh team data
                await this.loadTeamData();

            } catch (error) {
                alert(error.message);
            } finally {
                this.isProcessingInvitation = false;
                this.currentInvitationId = null;
            }
        },

        async cancelInvitation(invitationId, email) {
            if (!confirm(`Cancel invitation to ${email}? This cannot be undone.`)) {
                return;
            }

            this.isProcessingInvitation = true;
            this.currentInvitationId = invitationId;

            try {
                const response = await fetch(`/api/users/invitations/${invitationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to cancel invitation');
                }

                alert('Invitation canceled successfully');
                
                // Refresh team data
                await this.loadTeamData();

            } catch (error) {
                alert(error.message);
            } finally {
                this.isProcessingInvitation = false;
                this.currentInvitationId = null;
            }
        }
    },
    async created() {
        const token = localStorage.getItem('token');
        if (!token) {
            if (window.redirectToLogin) window.redirectToLogin('no_token', { from: 'user-management' });
            else window.location.replace('/login?loop=1&reason=no_token&from=user-management');
            return;
        }
        
        await this.loadUserData();
        await this.loadTeamData();
    }
}).mount('#app')
</script>
</div> 